<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>COMPSCI 326 Web Programming</title>
  <meta name="description" content="Spring 2017 Web Programming">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/workshop/09">
  <link rel="alternate" type="application/rss+xml" title="COMPSCI 326 Web Programming" href="/feed.xml">

  <!-- adds support for reading time -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="/assets/js/readremaining.jquery.js"></script>
  <link rel="stylesheet" href="/assets/css/rr_dark.css"/>
  <script>
    $(function () {
      $('body').readRemaining({ showGaugeOnStart : true , showGaugeDelay : 1 });
    });    
  </script>

  <!-- Adds support for lightbox -->
  <link href="/assets/css/lightbox.css" rel="stylesheet"/>
  <script src="/assets/js/lightbox.js"></script>
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">COMPSCI 326 Web Programming</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    
<h1 class="no_toc" id="workshop-09-writing-a-web-server">Workshop 09: Writing a Web Server</h1>

<ul id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#grading-rubric" id="markdown-toc-grading-rubric">Grading Rubric</a></li>
  <li><a href="#git-repository-introduction" id="markdown-toc-git-repository-introduction">Git Repository Introduction</a>    <ul>
      <li><a href="#folder-structure" id="markdown-toc-folder-structure">Folder structure</a></li>
      <li><a href="#mock-database-improvements" id="markdown-toc-mock-database-improvements">Mock Database Improvements</a></li>
      <li><a href="#facebook-changes" id="markdown-toc-facebook-changes">Facebook Changes</a>        <ul>
          <li><a href="#editdelete-dropdown" id="markdown-toc-editdelete-dropdown">Edit/Delete Dropdown</a></li>
          <li><a href="#delete-status-update" id="markdown-toc-delete-status-update">Delete Status Update</a></li>
          <li><a href="#edit-status-update" id="markdown-toc-edit-status-update">Edit Status Update</a></li>
          <li><a href="#search" id="markdown-toc-search">Search</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#http" id="markdown-toc-http">HTTP</a>    <ul>
      <li><a href="#overview-1" id="markdown-toc-overview-1">Overview</a></li>
      <li><a href="#requests" id="markdown-toc-requests">Requests</a></li>
      <li><a href="#responses" id="markdown-toc-responses">Responses</a></li>
      <li><a href="#authentication-with-tokens" id="markdown-toc-authentication-with-tokens">Authentication with Tokens</a></li>
    </ul>
  </li>
  <li><a href="#applying-http-to-facebook" id="markdown-toc-applying-http-to-facebook">Applying HTTP to Facebook</a>    <ul>
      <li><a href="#mapping-facebook-objects-to-http-resources" id="markdown-toc-mapping-facebook-objects-to-http-resources">Mapping Facebook Objects to HTTP Resources</a></li>
      <li><a href="#mapping-facebook-server-methods-to-http-requests" id="markdown-toc-mapping-facebook-server-methods-to-http-requests">Mapping Facebook Server Methods to HTTP Requests</a></li>
      <li><a href="#authentication" id="markdown-toc-authentication">Authentication</a></li>
    </ul>
  </li>
  <li><a href="#setup-and-background-node-and-express" id="markdown-toc-setup-and-background-node-and-express">Setup and Background: Node and Express</a>    <ul>
      <li><a href="#setup" id="markdown-toc-setup">Setup</a></li>
      <li><a href="#nodejs-introduction" id="markdown-toc-nodejs-introduction">Node.JS Introduction</a>        <ul>
          <li><a href="#hello-world" id="markdown-toc-hello-world">“Hello World!”</a></li>
          <li><a href="#node-commonjs-modules" id="markdown-toc-node-commonjs-modules">Node “CommonJS” Modules</a></li>
          <li><a href="#writing-and-debugging-a-program" id="markdown-toc-writing-and-debugging-a-program">Writing and Debugging a Program</a></li>
        </ul>
      </li>
      <li><a href="#express-introduction" id="markdown-toc-express-introduction">Express Introduction</a>        <ul>
          <li><a href="#hello-world-1" id="markdown-toc-hello-world-1">Hello World!</a></li>
          <li><a href="#send-http-requests-with-postman" id="markdown-toc-send-http-requests-with-postman">Send HTTP Requests with Postman</a></li>
          <li><a href="#lets-post-stuff" id="markdown-toc-lets-post-stuff">Let’s POST stuff!</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#writing-a-server-for-facebook" id="markdown-toc-writing-a-server-for-facebook">Writing a Server for Facebook</a>    <ul>
      <li><a href="#setup-1" id="markdown-toc-setup-1">Setup</a></li>
      <li><a href="#serve-up-html-css-and-javascript" id="markdown-toc-serve-up-html-css-and-javascript">Serve up HTML, CSS, and JavaScript</a></li>
      <li><a href="#migrate-data-to-mock-database-on-server" id="markdown-toc-migrate-data-to-mock-database-on-server">Migrate Data to Mock Database on Server</a></li>
      <li><a href="#implement-a-single-route-on-the-server" id="markdown-toc-implement-a-single-route-on-the-server">Implement a single route on the server</a></li>
      <li><a href="#communicating-with-the-server-from-the-client" id="markdown-toc-communicating-with-the-server-from-the-client">Communicating with the Server from the Client</a></li>
      <li><a href="#handling-http-requests-that-fail" id="markdown-toc-handling-http-requests-that-fail">Handling HTTP Requests That Fail</a></li>
      <li><a href="#poststatusupdate-and-validating-data-with-json-schema" id="markdown-toc-poststatusupdate-and-validating-data-with-json-schema">postStatusUpdate, and Validating Data with JSON Schema</a></li>
      <li><a href="#implement-the-rest-of-the-routes" id="markdown-toc-implement-the-rest-of-the-routes">Implement the Rest of the Routes</a>        <ul>
          <li><a href="#reset-database" id="markdown-toc-reset-database">Reset Database</a></li>
          <li><a href="#updatefeeditemtext" id="markdown-toc-updatefeeditemtext">updateFeedItemText</a></li>
          <li><a href="#deletefeeditem" id="markdown-toc-deletefeeditem">deleteFeedItem</a></li>
          <li><a href="#likefeeditem" id="markdown-toc-likefeeditem">likeFeedItem</a></li>
          <li><a href="#unlikefeeditem" id="markdown-toc-unlikefeeditem">unlikeFeedItem</a></li>
          <li><a href="#searchforfeeditems" id="markdown-toc-searchforfeeditems">searchForFeeditems</a></li>
        </ul>
      </li>
      <li><a href="#commit-your-changes" id="markdown-toc-commit-your-changes">Commit Your Changes</a></li>
    </ul>
  </li>
  <li><a href="#add-comment-routes-yourself" id="markdown-toc-add-comment-routes-yourself">Add Comment Routes Yourself!</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
  <li><a href="#submission" id="markdown-toc-submission">Submission</a></li>
</ul>

<h1 id="overview">Overview</h1>

<p>In the previous workshop, you created a dynamic mockup of Facebook using React. The mockup lets you post status updates and comments as a single user, and let you “Like” things too. The mockup saved all of the data in <strong>your browser</strong>, so that if you revisited it from the same computer using the same web browser, you would see the same status updates, comments, and Likes as the last time you visited the webpage.</p>

<p>In this workshop, we’ll extend that dynamic mockup with a custom HTTP server. With a server, the mockup will have the same status updates, comments, and “Likes” across web browsers and computers. We will continue to assume that a single user is logged in; we still need to add a database before we are ready to handle user authentication.</p>

<p><strong>Please be sure to check the grading rubric before starting.</strong> If you are missing a part of the assignment, we assign you 0 points for that rubric item regardless of the quality of your submission.</p>

<h1 id="grading-rubric">Grading Rubric</h1>

<ul>
  <li>10% <code class="highlighter-rouge">node</code> commit</li>
  <li>5% <code class="highlighter-rouge">express</code> commit</li>
  <li>5% <code class="highlighter-rouge">static</code> commit</li>
  <li>5% <code class="highlighter-rouge">database</code> commit</li>
  <li>5% <code class="highlighter-rouge">getFeedData</code> commit</li>
  <li>5% <code class="highlighter-rouge">facebookGotServed</code> commit</li>
  <li>10% <code class="highlighter-rouge">failbook</code> commit
    <ul>
      <li>5% Error banner screenshot</li>
      <li>5% Code for the error banner / error handling</li>
    </ul>
  </li>
  <li>10% <code class="highlighter-rouge">validation</code> commit</li>
  <li>15% <code class="highlighter-rouge">almostDone</code> commit</li>
  <li>30% <code class="highlighter-rouge">missionAccomplished</code> commit
    <ul>
      <li>10% Add a route to the server for <code class="highlighter-rouge">postComment</code>, <code class="highlighter-rouge">likeComment</code>, and <code class="highlighter-rouge">unlikeComment</code>.</li>
      <li>10% Update the functions in <code class="highlighter-rouge">client/app/server.js</code> to issue HTTP requests.</li>
      <li>5% Create a JSON schema for comment data, and place it into <code class="highlighter-rouge">server/src/schemas/comment.json</code></li>
      <li>5% Validate comment data input to <code class="highlighter-rouge">postComment</code> using the JSON schema.</li>
    </ul>
  </li>
</ul>

<h1 id="git-repository-introduction">Git Repository Introduction</h1>

<p>To get the starter code for this workshop, open up the terminal, <code class="highlighter-rouge">cd</code> into your <strong>class folder</strong>, fork the <a href="https://github.com/umass-cs-326/Workshop6">repository</a>, and <code class="highlighter-rouge">cd</code> into the repository folder.</p>

<p><strong>Note: Yes, the name of the repository is Workshop6, it will be updated in future offerings of this course</strong>.</p>

<p>Below, we explain the folder structure of the git repository, the extra features we have added to the Facebook client, and changes we have made to the mock database. You should not skip this section – some of the changes we have made may be useful sample code to look at for your startup products!</p>

<h2 id="folder-structure">Folder structure</h2>

<p>The Git repository has two folders:</p>

<ul>
  <li><code class="highlighter-rouge">client/</code>: Contains the <em>client side</em> of the web application.
    <ul>
      <li>This contains all of the JavaScript/HTML/CSS that runs in a user’s web browser.</li>
      <li>Right now, it contains the dynamic mockup from the previous workshop.</li>
      <li>We will alter the client to query data from a server in this workshop.</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">server/</code>: Contains the <em>server side</em> of the web application.
    <ul>
      <li>This contains all of the JavaScript and server files that run on your server – which would typically be a machine in the cloud.</li>
      <li>Right now, it only contains a few files. We will fill this out with a server in this workshop.</li>
    </ul>
  </li>
</ul>

<p>We will later cover the commands you need to run to set up these folders.</p>

<h2 id="mock-database-improvements">Mock Database Improvements</h2>

<p>We’ve added the following functions to the mock database:</p>

<ul>
  <li><code class="highlighter-rouge">deleteDocument(collection, id)</code>: Deletes an object in a collection.</li>
  <li><code class="highlighter-rouge">getCollection(collection)</code>: Returns all objects in a collection. Makes it possible to emulate database queries.</li>
</ul>

<p>We have also added basic error messages to the database to make it clear when your code is accessing invalid database collections or objects.</p>

<h2 id="facebook-changes">Facebook Changes</h2>

<p>To check out the updated Facebook mockup, run the following terminal commands from the repository folder:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd client
$ npm install
$ npm run serve
</code></pre>
</div>

<p>Then, open your web browser to <a href="http://localhost:8080">http://localhost:8080/</a>.</p>

<p>We have added the following features to Facebook since the previous workshop:</p>

<ul>
  <li><strong>Edit Status Updates</strong>: Click the caret in the corner of status updates you’ve authored
(where “you” is the logged in user – “John Vilk”), and click on “Edit Status Update”.</li>
  <li><strong>Delete Status Updates</strong>: From the same menu, click “Delete Status Update”.</li>
  <li><strong>Search</strong>: Type a search query into the search bar at the top, and click the search button or hit enter. The search will return results that include the text in the content of the status update itself.</li>
  <li><strong>Moved HTML into Components</strong>: We have moved elements on the page like the left and right menus into React components to make Facebook more like your startup products.</li>
</ul>

<p>Let’s look through some of the code changes we had to make to get these features working!</p>

<h3 id="editdelete-dropdown">Edit/Delete Dropdown</h3>

<p>The dropdown is in <code class="highlighter-rouge">app/components/statusupdate.js</code>. We added a <a href="http://getbootstrap.com/components/#dropdowns">Bootstrap dropdown menu</a> into the <code class="highlighter-rouge">render()</code> function of the <code class="highlighter-rouge">StatusUpdate</code> component. While the sample Bootstrap dropdowns use <code class="highlighter-rouge">button</code> elements as the dropdown target, you can use any element you want as the target:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">className=</span><span class="s">{"dropdown"}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">className=</span><span class="s">"caret pull-right dropdown-toggle"</span> 
	    <span class="na">data-toggle=</span><span class="s">"dropdown"</span><span class="nt">&gt;&lt;/span&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">className=</span><span class="s">"dropdown-menu"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">className=</span><span class="s">{hideElement(this.props.author._id</span> <span class="err">!==</span> <span class="na">4</span><span class="err">)}</span><span class="nt">&gt;</span>
		<span class="nt">&lt;a</span> <span class="na">onClick=</span><span class="s">{(e)</span> <span class="err">=</span><span class="nt">&gt;</span> this.onEditClick(e)}&gt;
		  Edit Status Update<span class="nt">&lt;/a&gt;</span>
	<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li</span> <span class="na">className=</span><span class="s">{hideElement(this.props.author._id</span> <span class="err">!==</span> <span class="na">4</span><span class="err">)}</span><span class="nt">&gt;</span>
		<span class="nt">&lt;a</span> <span class="na">onClick=</span><span class="s">{(e)</span> <span class="err">=</span><span class="nt">&gt;</span> this.onDelete(e)}&gt;
		  Delete Status Update<span class="nt">&lt;/a&gt;</span>
	<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Hide Post<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>Notice how the “Edit” and “Delete” dropdown menu items are <strong>always included in the return value from <code class="highlighter-rouge">render()</code></strong>, but, on Facebook, they only show up on posts that you have authored. Rather than not include them in the return value of <code class="highlighter-rouge">render()</code>, we set their CSS property <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/display#Values"><code class="highlighter-rouge">display</code> to <code class="highlighter-rouge">'none'</code></a>. This is a simple HTML trick that <a href="https://facebook.github.io/react/docs/multiple-components.html#stateful-children">React recommends you use</a> when convenient.</p>

<p>We added a CSS class to <code class="highlighter-rouge">build/css/facebook.css</code> to set this property:</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code><span class="c">/* Prevent an HTML element from displaying at all. */</span>
<span class="nc">.hidden</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="s2">'none'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>We use a helper function called <code class="highlighter-rouge">hideElement</code> to <code class="highlighter-rouge">app/util.js</code> that returns <code class="highlighter-rouge">hidden</code> when the input test is <code class="highlighter-rouge">true</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * If shouldHide is true, returns a CSS class that hides the element.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">hideElement</span><span class="p">(</span><span class="nx">shouldHide</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">shouldHide</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'hidden'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">''</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Thus, when <code class="highlighter-rouge">this.props.author._id !== 4</code>, both the Edit and Delete items are <em>effectively</em> removed from the UI.</p>

<h3 id="delete-status-update">Delete Status Update</h3>

<p>Clicking on the “Delete” item in the dropdown menu calls <code class="highlighter-rouge">this.props.onDelete</code>. <code class="highlighter-rouge">Feed</code> provides <code class="highlighter-rouge">onDelete</code> to <code class="highlighter-rouge">FeedItem</code>s, and <code class="highlighter-rouge">FeedItem</code> passes it on to <code class="highlighter-rouge">StatusUpdate</code>. <code class="highlighter-rouge">onDelete</code> simply calls <code class="highlighter-rouge">Feed.deleteFeedItem(id)</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">deleteFeedItem</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">deleteFeedItem</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">deleteFeedItem</code> is a new server method, which uses the new <code class="highlighter-rouge">deleteDocument</code> database function:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Deletes a feed item.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">deleteFeedItem</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Assumption: The current user authored this feed item.</span>
  <span class="nx">deleteDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
  <span class="c1">// Remove references to this feed item from all other feeds.</span>
  <span class="kd">var</span> <span class="nx">feeds</span> <span class="o">=</span> <span class="nx">getCollection</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">feedIds</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">feeds</span><span class="p">);</span>
  <span class="nx">feedIds</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">feedId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">feed</span> <span class="o">=</span> <span class="nx">feeds</span><span class="p">[</span><span class="nx">feedId</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">itemIdx</span> <span class="o">=</span> <span class="nx">feed</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">itemIdx</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Splice out of array.</span>
      <span class="nx">feed</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">itemIdx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="c1">// Update feed.</span>
      <span class="nx">writeDocument</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">,</span> <span class="nx">feed</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Return nothing. The return just tells the client that</span>
  <span class="c1">// the server has acknowledged the request, and that it has</span>
  <span class="c1">// been a success.</span>
  <span class="nx">emulateServerReturn</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="edit-status-update">Edit Status Update</h3>

<p>We changed <code class="highlighter-rouge">app/components/statusupdate.js</code> so that it contains the following state variables:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// If 'true', the user is currently editing the status update.</span>
  <span class="na">editing</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="c1">// If 'true', the user clicked 'edit', and the status update is waiting</span>
  <span class="c1">// for the edit to occur.</span>
  <span class="na">editSubmitted</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="c1">// The current value of the edited status update. As the user types data into</span>
  <span class="c1">// the edit box, this value updates.</span>
  <span class="na">editedValue</span><span class="p">:</span> <span class="s1">''</span>
<span class="p">};</span>
</code></pre>
</div>

<p>In <code class="highlighter-rouge">render()</code>, we only display the edit dialog when <code class="highlighter-rouge">editing</code> is true, and we also hide the status update:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;span</span> <span class="na">className=</span><span class="s">{hideElement(!this.state.editing)}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;textarea</span> <span class="na">disabled=</span><span class="s">{this.state.editSubmitted}</span> 
	        <span class="na">className=</span><span class="s">"form-control fb-status-update-edit-box"</span>
			<span class="na">rows=</span><span class="s">{countLines(this.state.editedValue).toString()}</span> 
			<span class="na">value=</span><span class="s">{this.state.editedValue}</span>
			<span class="na">onChange=</span><span class="s">{(e)</span> <span class="err">=</span><span class="nt">&gt;</span> this.handleEditChange(e)} /&gt;
  <span class="nt">&lt;span</span> <span class="na">className=</span><span class="s">"fb-status-update-edit-buttons"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">className=</span><span class="s">"btn-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">className=</span><span class="s">"btn btn-default"</span>
        <span class="na">onClick=</span><span class="s">{(e)</span> <span class="err">=</span><span class="nt">&gt;</span> this.onEditCancel(e)} 
	    disabled={this.state.editSubmitted}&gt;Cancel<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">className=</span><span class="s">"btn-group pull-right"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">className=</span><span class="s">"btn btn-default"</span>
        <span class="na">onClick=</span><span class="s">{(e)</span> <span class="err">=</span><span class="nt">&gt;</span> this.onEdit(e)} 
		disabled={this.state.editSubmitted}&gt;Edit<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;span</span> <span class="na">className=</span><span class="s">{hideElement(this.state.editing)}</span><span class="nt">&gt;</span>
{
  this.props.value.split('\n').map((line, i) =&gt; {
    return <span class="nt">&lt;p</span> <span class="na">key=</span><span class="s">{"line"</span> <span class="err">+</span> <span class="na">i</span><span class="err">}</span><span class="nt">&gt;</span>{line}<span class="nt">&lt;/p&gt;</span>
  })
}
<span class="nt">&lt;/span&gt;</span>
</code></pre>
</div>

<p>We set <code class="highlighter-rouge">disabled</code> to <code class="highlighter-rouge">true</code> on the <code class="highlighter-rouge">Edit</code> button, <code class="highlighter-rouge">Cancel</code> button, and the <code class="highlighter-rouge">textarea</code> when <code class="highlighter-rouge">editSubmitted</code> is <code class="highlighter-rouge">true</code>; this prevents the user from making a second edit before the server responds.</p>

<p>When the <code class="highlighter-rouge">StatusUpdate</code> component receives new properties, it knows that a server request has completed since <code class="highlighter-rouge">FeedItem</code> has re-rendered the <code class="highlighter-rouge">StatusUpdate</code> with the new properties; it can reset its state to return to the regular <code class="highlighter-rouge">StatusUpdate</code> view:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">componentWillReceiveProps</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">editing</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">editSubmitted</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Component has received its new status update text!</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">editing</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">editSubmitted</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="search">Search</h3>

<p><code class="highlighter-rouge">app/app.js</code> has a new class called <code class="highlighter-rouge">SearchResultsPage</code>, which handles the route <code class="highlighter-rouge">/search</code>. It expects a parameter called <code class="highlighter-rouge">query</code>, so <code class="highlighter-rouge">http://localhost:8080/search?query=foo</code> will link to the search results for the query “foo”.</p>

<p><code class="highlighter-rouge">SearchResultsPage</code> renders a single <code class="highlighter-rouge">SearchResults</code> component, which is also defined in <code class="highlighter-rouge">app/app.js</code>. It uses the search query as that component’s key, and also passes the query as a prop. <code class="highlighter-rouge">SearchResults</code> queries the mock server for search results when it is first mounted (via <code class="highlighter-rouge">componentDidMount</code>), and sets its state with results once the server responds.</p>

<p>If the search query changes, <code class="highlighter-rouge">SearchResultsPage</code> will render a <code class="highlighter-rouge">SearchResults</code> with a different <code class="highlighter-rouge">key</code>, causing React to create a new instance of the <code class="highlighter-rouge">SearchResults</code> component. If the query does not change, it renders a <code class="highlighter-rouge">SearchResults</code> with the same <code class="highlighter-rouge">key</code>, causing React’s diffing algorithm to keep the old instance. This design bypasses some of the state issues some startups had with their search pages – no more need to handle <code class="highlighter-rouge">componentWillReceiveProps</code>!</p>

<p><code class="highlighter-rouge">app/server.js</code> contains a new route called <code class="highlighter-rouge">searchForFeedItems</code>, which searches the current user’s <code class="highlighter-rouge">feed</code> for FeedItem entities whose contents contain the search query.</p>

<p><code class="highlighter-rouge">app/components/searchbar.js</code> programmatically navigates to the search page using React-Router when a user enters a search query into the navigation bar. If the current page is the search page, <code class="highlighter-rouge">SearchBar</code> receives the current search from the <code class="highlighter-rouge">Navbar</code> component in <code class="highlighter-rouge">app/components/navbar.js</code>, which receives it from the <code class="highlighter-rouge">App</code> component in <code class="highlighter-rouge">app/app.js</code>.</p>

<h1 id="http">HTTP</h1>

<p>We discussed HTTP in depth; you may want to review those slides before proceeding further. We will recap the information below, and build on it to create our webserver.</p>

<h2 id="overview-1">Overview</h2>

<p>HTTP is a protocol (i.e. a set of rules) that dictate how a client and a webserver talk to one another. Typically, the client is a web browser. HTTP uses <em>messages</em> to communicate between clients and webservers. There are two types of messages:</p>

<ul>
  <li><strong>Request</strong>: A <em>Request</em> is a message sent from the <em>client</em> to the <em>webserver</em>.</li>
  <li><strong>Response</strong>: A <em>Response</em> is a message sent from the <em>webserver</em> to the <em>client</em> in response to a <em>request</em>.</li>
</ul>

<p>Here are some overall rules regarding HTTP messages:</p>

<ul>
  <li><strong>A webserver must send a single response to all requests.</strong> This statement has two implications.
    <ul>
      <li><strong>All requests must receive a response</strong>: If a client does not receive a response to a request, it has no idea if the server ever received the request. Even if the response is empty, it tells the client that the server received the request.
        <ul>
          <li>If no response ever arrives, then either the webserver is down, the network is having a problem, or the webserver is ignoring the request entirely.</li>
        </ul>
      </li>
      <li><strong>Servers cannot send multiple responses to a single request</strong>: The client needs to know that when it can stop expecting messages from the server so it can get on with its business. This rule lets the client break away once it receives responses to all of its requests.</li>
    </ul>
  </li>
  <li><strong>A webserver can only communicate with the client via responses.</strong> While a client can contact a server at any time, a server <em>cannot</em> send a message to a client at any time. It can only communicate with a client through responses to client requests.
    <ul>
      <li>There is a <a href="https://en.wikipedia.org/wiki/Server-sent_events">web standard that lets web servers “push” data to clients</a> using unsolicited HTTP responses, but it is not yet supported in all browsers and seems unlikely to come into common use. (It’s over a decade old now.)</li>
      <li>Most web browsers have standardized around <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a> instead for “push” features, which does not use HTTP at all for the connection.
        <ul>
          <li>We will not cover WebSockets in the course.</li>
        </ul>
      </li>
      <li>A common technique for emulating “pushed” data is to have the client poll for it by sending a request on a regular basis. For example, a chat application may ask the server if there are new chat messages every 50 milliseconds using a <code class="highlighter-rouge">GET</code> request.</li>
    </ul>
  </li>
</ul>

<p>With those rules in mind, let’s describe the two message types.</p>

<h2 id="requests">Requests</h2>

<p>Requests have four main components:</p>

<ul>
  <li><strong>Verb</strong>: The <em>action</em> to perform.
    <ul>
      <li>Example: <code class="highlighter-rouge">GET</code> retrieves the contents of a target</li>
    </ul>
  </li>
  <li><strong>Resource</strong>: The <em>target</em> of the action.
    <ul>
      <li>Example: <code class="highlighter-rouge">/feeditem/3</code> is the Feed Item with ID 3.</li>
    </ul>
  </li>
  <li><strong>Body</strong> (optional): Any data required to carry out the action.
    <ul>
      <li>Example: A Status Update in JSON form when creating a new status update</li>
    </ul>
  </li>
  <li><strong>Header</strong> (metadata): Metadata about the response, including information about the client (what version of HTTP to use, what responses the client accepts, etc.)
    <ul>
      <li>The Header is where you put authentication tokens, which we will explain soon.</li>
      <li>Most of this data is automatically created for you. You can add arbitrary fields of data to this header, too.
        <ul>
          <li>Sidenote: HTTP is decades old, so this metadata contains all of the information the server needs to figure out how to respond. For example, newer HTTP clients, like your web browser, support <em>compressed responses</em>, which reduces the size of messages using a compression algorithm. Some HTTP clients may not support compression. The metadata tells the server if it can compress the response or not. But, again, all of the APIs you deal with in this course will handle these details for you.</li>
        </ul>
      </li>
      <li><a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields">Wikipedia has a list of common header fields</a></li>
    </ul>
  </li>
</ul>

<p>There are 4 main verbs we will use in this course, which are all that most web developers ever need. <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#Request_methods">There are a number of others that are available</a>, and you can feel free to use them in your startups if they seem useful. The 4 main verbs are:</p>

<ul>
  <li><strong>GET</strong>: Retrieve a specified resource.
    <ul>
      <li>Example: <code class="highlighter-rouge">GET /feeditem/3</code> retrieves the FeedItem with ID 3.</li>
    </ul>
  </li>
  <li><strong>POST</strong>: Typically, POST creates a new resource as a <em>subordinate</em> of the target resource using the specified data. POST doesn’t have to create a new resource, though.
    <ul>
      <li>Example: <code class="highlighter-rouge">POST /feeditem [feed item JSON object]</code> creates a new FeedItem (e.g. <code class="highlighter-rouge">/feeditem/4</code>) with the specified data. The server can tell the client what the new Feed Item’s ID is in the response.
        <ul>
          <li>Note that <code class="highlighter-rouge">/feeditem/4</code> is a <em>subordinate</em> of <code class="highlighter-rouge">/feeditem</code>.</li>
        </ul>
      </li>
      <li>Example: <code class="highlighter-rouge">POST /forgotpasswordemail { email: "jondoe@gmail.com" }</code> sends a “Forgot Password” email to the given email.
        <ul>
          <li>Note that this does not create a new resource!</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>PUT</strong>: Create or change the target resource using the given data.
    <ul>
      <li>Example: <code class="highlighter-rouge">PUT /feeditem/3 [feed item data]</code> modifies the Feed Item with ID 3 using the given data.</li>
    </ul>
  </li>
  <li><strong>DELETE</strong>: Delete the target resource.
    <ul>
      <li>Example: <code class="highlighter-rouge">DELETE /feeditem/3</code> deletes the Feed item with iD 3.</li>
    </ul>
  </li>
</ul>

<p>HTTP requests should be <em>stateless</em>; each individual request should contain all the information necessary to service the request. As you can see from the above examples, the intent of an individual HTTP request is quite explicit, and can be understood without knowing what requests have come before or after. This is not typically true of the English language, where the meaning of a sentence depends on the context surrounding it!</p>

<h2 id="responses">Responses</h2>

<p>Once a web server receives a request, it needs to decide how to handle it – or if it should handle it at all! Its response should reflect what it decided to do.</p>

<p>An HTTP response contains the following data:</p>

<ul>
  <li><strong>Status Code</strong>: A response always contains a <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP status code</a>, which describes the nature of the response (or the error if one has occurred).
    <ul>
      <li>Famously, <code class="highlighter-rouge">404</code> is “NOT FOUND” – the target resource was not found. <code class="highlighter-rouge">200</code> is OK, <code class="highlighter-rouge">201</code> is CREATED (a new resource), <code class="highlighter-rouge">401</code> is UNAUTHORIZED. These 3 are the most common that you will use.</li>
      <li><a href="https://developer.github.com/changes/2016-03-17-the-451-status-code-is-now-supported/">New HTTP status codes</a> are continually emerging, too.</li>
    </ul>
  </li>
  <li><strong>Body</strong> (optional): Additional data associated with the response.
    <ul>
      <li>Example: The body of a successful <code class="highlighter-rouge">GET /feeditem/3</code> response would contain the contents of that feed item.</li>
    </ul>
  </li>
  <li><strong>Header</strong> (metadata): Like with the header on requests, the header of the response contains metadata about the server, which informs the client how it may communicate with the server / what features the server supports.
    <ul>
      <li>You will not have to worry about the header in this course, as the APIs you will use automatically handle it for you.</li>
    </ul>
  </li>
</ul>

<p>Example responses:</p>

<ul>
  <li>Successful <code class="highlighter-rouge">GET /feeditem/3</code>: Status code <code class="highlighter-rouge">200</code> (OK), body contains the feed item</li>
  <li>Successful <code class="highlighter-rouge">POST /feeditem [feed item data]</code>: Status code <code class="highlighter-rouge">201</code> (CREATED), body contains the feed item data, and, <a href="https://en.wikipedia.org/wiki/HTTP_location">special for the <code class="highlighter-rouge">201</code> status code, the header contains <code class="highlighter-rouge">Location</code> set to <code class="highlighter-rouge">/feeditem/:feeditemid</code>, where <code class="highlighter-rouge">:feeditemid</code> is the ID of the new feed item</a>.</li>
  <li>Successful <code class="highlighter-rouge">PUT /feeditem/3 [feed item data]</code>: Status code <code class="highlighter-rouge">200</code> (OK), body contains modified feed item.</li>
  <li>Successful <code class="highlighter-rouge">DELETE /feeditem/3</code>: Status code <code class="highlighter-rouge">200</code> (OK), body is empty.</li>
</ul>

<h2 id="authentication-with-tokens">Authentication with Tokens</h2>

<p>How does the web server know who is sending a particular request? It uses <em>tokens</em>! In this class, we will use JSON Web Tokens. In the HTTP response to an HTTP request where a user logs in with a correct username/password, the server sends an <em>encrypted JSON object</em> that only <em>the server</em> can decrypt. The encrypted JSON object appears as a string of random-looking letters and numbers. The <em>client</em> cannot decrypt the string, and has no idea what it contains. Assuming the server is using the latest and greatest in encryption, and its encryption key is properly kept secret from prying eyes, <strong>it is infeasible for anyone but the server to create these tokens.</strong></p>

<p>The <em>client</em> will send this token with all future HTTP requests to verify its identity. If the <em>server</em> can successfully decrypt the token, it knows that the token must have come from itself! (Otherwise, someone has forged an encrypted JSON object, which is infeasible unless they had the server’s encryption key.)</p>

<p><strong>A JSON web token can contain any data that you want it to.</strong> Typically, it will only contain the requester’s username and an expiration date, but it’s completely up to you! Since the token will be sent with every HTTP request, you’ll want to make it short.</p>

<p>We won’t be using full-blown JSON web tokens in the class until we cover user login in a later workshop. Instead, for this workshop and for your startup submission, you will send <em>unencrypted</em> JSON objects with all “privileged” HTTP requests that contain the same information you would put into a token. Later on, you can reuse all of the logic you’ve developed in this workshop and your startup submission when you transition to real JSON Web Tokens. :)</p>

<h1 id="applying-http-to-facebook">Applying HTTP to Facebook</h1>

<p>Now that we have discussed HTTP requests and responses, let us figure out how to map entities from our database onto HTTP resources! Note that there are multiple ways that we could map these objects to HTTP resources. We are merely presenting one consistent way to go about doing it in this case.</p>

<p>We will also discuss how to map mock server methods onto HTTP requests over HTTP resources.</p>

<p><strong>You are going to have to do some thinking here.</strong> If you had trouble understanding what we mentioned in the previous section (or, worse, skipped it!), you may want to go back and review it.</p>

<h2 id="mapping-facebook-objects-to-http-resources">Mapping Facebook Objects to HTTP Resources</h2>

<p>As a reminder of Facebook’s entities, here is the Facebook ER diagram:</p>

<p><img src="/workshops/images/facebook_entity_diagram_labeled.png" alt="Facebook Entity Diagram" /></p>

<p>Here are some general rules on how to map the labeled ER diagram to HTTP resources:</p>

<ul>
  <li><strong>Embedded entities should be subordinates of the URL to the entity they are embedded into.</strong>
    <ul>
      <li>For example, the <code class="highlighter-rouge">LikeList</code> for a <code class="highlighter-rouge">FeedItem</code> located at <code class="highlighter-rouge">/feeditem/3</code> should be accessible at <code class="highlighter-rouge">/feeditem/3/likelist</code>. Then, if someone successfully executes <code class="highlighter-rouge">DELETE /feeditem/3</code>, naturally any subordinate of <code class="highlighter-rouge">/feeditem/3</code>, such as the <code class="highlighter-rouge">LikeList</code> are also gone. If the <code class="highlighter-rouge">LikeList</code> were at <code class="highlighter-rouge">/likelist/3</code>, then <code class="highlighter-rouge">DELETE /feeditem/3</code> would unnaturally also delete <code class="highlighter-rouge">/likelist/3</code>.</li>
    </ul>
  </li>
  <li><strong>Entities that were not embedded previously due to size concerns should be subordinates of the URL to the entity they were nearly embedded into.</strong>
    <ul>
      <li>For example, we decided not to embed a User’s Feed into the User entity, since the Feed could be quite large and is not typically requested alongside a user. However, it clearly belongs to the user. Thus, the Feed should be accessible as a subordinate to the owning User’s URL, e.g. <code class="highlighter-rouge">/user/3/feed</code>.</li>
    </ul>
  </li>
  <li><strong>Otherwise, referenced entities should be their own top-level URL.</strong> For example, users should be accessed at <code class="highlighter-rouge">/user/:userid</code>.</li>
</ul>

<p>With that in mind, let’s translate all of the relevant entities in the diagram into HTTP resources:</p>

<ul>
  <li><strong><code class="highlighter-rouge">User</code>:</strong> <code class="highlighter-rouge">/user/:userid</code></li>
  <li><strong><code class="highlighter-rouge">FeedItem</code>:</strong> <code class="highlighter-rouge">/feeditem/:feeditemid</code> (While authored by a particular user, they belong to multiple feeds and could potentially persist after a user account is deleted.)</li>
  <li><strong><code class="highlighter-rouge">Feed</code> for a user:</strong> <code class="highlighter-rouge">/user/:userid/feed</code></li>
  <li><strong><code class="highlighter-rouge">LikeList</code> for a <code class="highlighter-rouge">FeedItem</code>:</strong> <code class="highlighter-rouge">/feeditem/:feeditemid/likelist</code></li>
  <li><strong>An individual <code class="highlighter-rouge">Like</code> in the <code class="highlighter-rouge">LikeList</code>:</strong> <code class="highlighter-rouge">/feeditem/:feeditemid/likelist/:userid</code>
    <ul>
      <li>Note: One cool thing about HTTP is these types of hierarchies. In some systems, <code class="highlighter-rouge">GET /user</code> will get you a listing of all users, and <code class="highlighter-rouge">GET /user/[userid]</code> will get you one particular user. Here, we are doing the same thing with the <code class="highlighter-rouge">LikeList</code>!</li>
    </ul>
  </li>
</ul>

<p>Now, you must decide where the following entities can be accessed:</p>

<ul>
  <li><strong><code class="highlighter-rouge">CommentThread</code>:</strong> The resource for a <code class="highlighter-rouge">CommentThread</code> should be the <em>parent</em> resource of an individual comment (e.g. in <code class="highlighter-rouge">/foo/bar/0</code>, <code class="highlighter-rouge">/foo/bar</code> is the parent). Where should a commentthread be?</li>
  <li><strong><code class="highlighter-rouge">Comment</code>:</strong> Where should a comment be?</li>
  <li><strong><code class="highlighter-rouge">LikeList</code> for a <code class="highlighter-rouge">Comment</code>:</strong> Where should a comment’s LikeList be?</li>
</ul>

<p>Record your answers somewhere. We will revisit them later on in the workshop, when you actually implement them. Please do this <em>now</em> before proceeding; we want you to use your <em>conceptual</em> understanding of HTTP to answer these questions <em>before</em> we dive into programming servers!</p>

<p>Note that since <code class="highlighter-rouge">StatusUpdate</code> <em>isa</em> <code class="highlighter-rouge">FeedItem</code>, we did not give it a unique URL; all <code class="highlighter-rouge">FeedItem</code>s are accessed via <code class="highlighter-rouge">/feeditem</code>.</p>

<h2 id="mapping-facebook-server-methods-to-http-requests">Mapping Facebook Server Methods to HTTP Requests</h2>

<p>We have mapped Facebook database entities to HTTP resources. Now, we can figure out the verbs to apply to those resources to bring the mock server methods to life! Like before, you will be responsible for figuring out some of these methods yourself.</p>

<p><strong><code class="highlighter-rouge">getFeedData(userid, cb)</code></strong>: Returns the Feed for the user with a given id.</p>

<p>This server function returns the feed associated with a user. The <code class="highlighter-rouge">GET</code> verb makes the most sense.</p>

<p>Thus, we will implement this server function using the request <code class="highlighter-rouge">GET /user/:userid/feed</code> (e.g. <code class="highlighter-rouge">GET /user/4/feed</code>). A successful response will return the <code class="highlighter-rouge">200</code> (OK) status code, along with the resolved feed in the body.</p>

<p><strong><code class="highlighter-rouge">postStatusUpdate(user, location, contents, cb)</code></strong>: Creates a new status update for the given user at the given location and with the given contents. Returns the new status update, along with its ID.</p>

<p>The <em>server</em> decides the new status update’s ID. The <code class="highlighter-rouge">POST</code> verb makes the most sense here, since the client does not know what the new <code class="highlighter-rouge">feeditem</code>’s ID will be and the request should create a new resource.</p>

<p>Thus, the request for this server function will look like the following: <code class="highlighter-rouge">POST /feeditem { userId: user, location: location, contents: contents  }</code></p>

<p>A success response should use the <code class="highlighter-rouge">201</code> (Created) status code, and include the FeedItem in the body of the response. Because we are using the <code class="highlighter-rouge">201</code> status code, the response should include the final URL for the newly-posted item <a href="https://en.wikipedia.org/wiki/HTTP_location">in the <code class="highlighter-rouge">Location</code> field of its header</a>.</p>

<p><strong><code class="highlighter-rouge">likeFeedItem(feedItemId, userId, cb)</code></strong>: Adds the given user to the like list on the given feed item.</p>

<p>The URL to the LikeList of a FeedItem is <code class="highlighter-rouge">/feeditem/:feeditemid/likelist</code>. The URL to a user’s like is <code class="highlighter-rouge">/feeditem/:feeditemid/likelist/:userid</code>. Since we know the URL to the user’s ‘like’ in the list, we can use <code class="highlighter-rouge">PUT</code>!</p>

<p>Thus, <code class="highlighter-rouge">PUT /feeditem/:feedItemId/likelist/:userId</code> is the request we would use. A success response should indicate <code class="highlighter-rouge">200</code> (OK).</p>

<p><strong><code class="highlighter-rouge">unlikeFeedItem(feedItemId, userId, cb)</code></strong>: Removes the given user from the like list on the given feed item.</p>

<p>We want to remove a user’s ‘like’ from the like list, so <code class="highlighter-rouge">DELETE</code> is the most appropriate verb.</p>

<p><code class="highlighter-rouge">DELETE /feeditem/:feedItemId/likelist/:userId</code> is the request we would use. A success response should indicate <code class="highlighter-rouge">200</code> (OK).</p>

<p><strong><code class="highlighter-rouge">updateFeedItemText(feedItemId, newContent, cb)</code></strong>: Update the text of the Feed Item with the given ID. Assumes the feed item is a status update.</p>

<p>The client knows the ID of the feed item it wants to update, so it knows the URL to that feed item (<code class="highlighter-rouge">/feeditem/:feedItemId</code>). <code class="highlighter-rouge">PUT</code> seems to be the most appropriate verb; the user wants to change the content of a resource at a known location.</p>

<p><code class="highlighter-rouge">PUT /feeditem/:feedItemId updatedFeedItem</code> seems like a clear choice for the request, but it’s actually not! The user only wants to update the <em>content</em> on a Feed Item, and not the entire Feed Item object. Recall that a Feed Item also contains other bits of information unrelated to this update, such as a LikeList and Comments. It is possible that a second user is <em>simultaneously</em> adding a comment to the same Feed Item as the author updates the Feed Item. You don’t want to wipe out their update!</p>

<p>Instead, we’ll use the request <code class="highlighter-rouge">PUT /feeditem/:feedItemId/content newContent</code>, which clearly only updates the <em>content</em> of a Feed Item. The response can contain the updated content of the Feed Item.</p>

<p><strong><code class="highlighter-rouge">deleteFeedItem(feedItemId, cb)</code></strong>: Deletes the Feed Item with the given ID.</p>

<p>By now, you should be getting the hang of this. The Feed Item is at URL <code class="highlighter-rouge">/feeditem/:feedItemId</code>, and we want to delete it… so we will use the request <code class="highlighter-rouge">DELETE /feeditem/:id</code>!</p>

<p><strong><code class="highlighter-rouge">searchForFeedItems(userID, queryText, cb)</code></strong>: Searches for Feed Items with the given query text.</p>

<p>This is a weird HTTP request. What verb do you think this should use? It’s a read-only operation, so you might be tempted to say <code class="highlighter-rouge">GET</code>, but <code class="highlighter-rouge">GET</code> is for retrieving a particular named resource; this is a request to perform an operation to locate resources!</p>

<p>Many services use <code class="highlighter-rouge">POST</code> for search requests, as the operation is not something that fetches
a named item or creates data. Thus, we will use <code class="highlighter-rouge">POST</code>, too.</p>

<p>What URL should we use? In this case, the URL is not the location of the <em>data</em>, but the location of the <em>operation</em> that we are invoking with <code class="highlighter-rouge">POST</code>. The operation is <em>search</em>, so we can simply use <code class="highlighter-rouge">/search</code>. The final HTTP request is <code class="highlighter-rouge">POST /search queryText</code>. (Note: Since <code class="highlighter-rouge">userID</code> is always the user ID of the current user, we can simply pull that piece of data from the JSON web token.)</p>

<p>If we wanted to support more advanced search queries (e.g. searches for users!), we could simply send a JSON object to <code class="highlighter-rouge">/search</code> that describes the search (e.g. <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">for:</span><span class="w"> </span><span class="nt">"users"</span><span class="err">,</span><span class="w"> </span><span class="err">query</span><span class="p">:</span><span class="w"> </span><span class="s2">"searchQuery"</span><span class="w"> </span><span class="p">}</span></code>. Or, we could create additional search resources for different search operations (e.g. <code class="highlighter-rouge">/search/users</code>).</p>

<p><strong>The Rest</strong></p>

<p>What HTTP requests do you think should be used for the following server methods?</p>

<ul>
  <li><code class="highlighter-rouge">postComment(feedItemId, author, contents, cb)</code>
    <ul>
      <li>Will your request still work properly if two users submit a comment at roughly the same time? It should!</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">likeComment(feedItemId, commentIdx, userId, cb)</code></li>
  <li><code class="highlighter-rouge">unlikeComment(feedItemId, commentIdx, userId, cb)</code></li>
</ul>

<p>Record your answers. We will revisit them later when you actually implement these methods on the server.</p>

<h2 id="authentication">Authentication</h2>

<p>To service a HTTP request, the Facebook server needs to know the requesting user’s ID. It does not need to know any additional information.</p>

<p>Facebook JSON web tokens will contain the following information:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
  <span class="c1">// The user's ID.</span>
  <span class="s2">"id"</span><span class="err">:</span> <span class="mi">4</span>
<span class="p">}</span>
</code></pre>
</div>

<p>That’s all of the information Facebook requires to authenticate a user’s access to information.</p>

<p>Since we are not covering authentication in this workshop, all HTTP requests will include an unencrypted string version of that object so the server knows who the request is coming from. We will hardcode the JSON object in the client.</p>

<p>This setup will make it easy to transition to “proper” authentication later on; we simply drop in a decryption routine on the server, and implement a login page on the client!</p>

<p><em>Fun Note: A more advanced setup might also put an expiration date into the token to auto-logout the user when the token expires.</em></p>

<h1 id="setup-and-background-node-and-express">Setup and Background: Node and Express</h1>

<p>Now that we know what HTTP is and how we will apply it to our Facebook mockup, it’s time for us to get acquainted with the software we will be using to write the server. You will write <strong>and</strong> debug code in these sections, and commit proof to the repository!</p>

<p>If you skimmed the previous section, or if it did not make sense, I urge you to look it over again. Check out some of the links, too, if they help. If you’re still lost, please post a <em>public</em> question to Piazza!</p>

<h2 id="setup">Setup</h2>

<p>First, open up a terminal and install <a href="https://github.com/node-inspector/node-inspector">Node Inspector</a>, which we will use to debug Node projects:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ npm install -g node-inspector
</code></pre>
</div>

<p><em>Note: If the above command fails on Linux or Mac, try running it with <code class="highlighter-rouge">sudo</code>.</em></p>

<p>Next, <a href="https://www.getpostman.com/">install Postman</a>. You can either install it to Google Chrome as an “Chrome App”, or install the standalone version if it is available for your platform; they are essentially the same thing. Postman makes it easy for you to test your web server with HTTP requests.</p>

<p>Next, open a terminal to this workshop’s <strong>Git repository folder</strong>. <code class="highlighter-rouge">cd</code> into <code class="highlighter-rouge">server</code>, and run the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ npm install
</code></pre>
</div>

<p>This command will install all of the server’s Node.js dependencies.</p>

<p>Finally, run the following command within the <code class="highlighter-rouge">server</code> folder to open up the Atom editor in the <code class="highlighter-rouge">server</code> folder:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ atom .
</code></pre>
</div>

<h2 id="nodejs-introduction">Node.JS Introduction</h2>

<p>Node.JS lets you write normal, non-browser applications in JavaScript. It doesn’t run these applications in a web browser, and it doesn’t have a DOM for GUIs, doesn’t support HTML or CSS, and is intended primarily for web server applications. Node.JS is popular because it lets developers write servers and clients in the same programming language: JavaScript. JavaScript also runs very quickly compared to programming languages like <a href="http://benchmarksgame.alioth.debian.org/u64q/compare.php?lang=v8&amp;lang2=php">PHP</a>, <a href="http://benchmarksgame.alioth.debian.org/u64q/compare.php?lang=v8&amp;lang2=yarv">Ruby</a>, and <a href="http://benchmarksgame.alioth.debian.org/u64q/compare.php?lang=v8&amp;lang2=python3">Python</a>, which are also popular choices for server software. (It’s not quite as fast as <a href="http://benchmarksgame.alioth.debian.org/u64q/javascript.html">Java</a>, though! Java is <em>very</em> fast.)</p>

<p>Node.JS ships with <a href="https://nodejs.org/dist/latest-v4.x/docs/api/">many APIs</a> that are not present in the web browser, such as an API for <a href="https://nodejs.org/dist/latest-v4.x/docs/api/fs.html">reading/writing files</a> and <a href="https://nodejs.org/dist/latest-v4.x/docs/api/net.html">opening TCP/UDP sockets</a>. You will not need to many use these interfaces directly in this course, though; we will use Node libraries that make it easy to write a web server, much like how we used React to write a web application instead of raw HTML/CSS/JavaScript!</p>

<p>Now that we have introduced Node.JS, let’s cover how to write, modularize, and debug a simple program!</p>

<h3 id="hello-world">“Hello World!”</h3>

<p>You should have Atom open within the <code class="highlighter-rouge">server</code> folder of the Git repository. Create a new file called <code class="highlighter-rouge">src/helloworld.js</code>, and include the following inside of it:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Hello World!"</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>Save</strong> the file, and open a terminal to the <code class="highlighter-rouge">server</code> folder of the Git repository. Run your new Node.JS program with the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ node src/helloworld.js
Hello World!
</code></pre>
</div>

<p>Congratulations, you just wrote a simple Node.JS application! No build step, no webpack, no <code class="highlighter-rouge">npm run serve</code>, no nonsense; Node programs ‘just work’.</p>

<h3 id="node-commonjs-modules">Node “CommonJS” Modules</h3>

<p>In the <strong>client</strong>, you have been writing ECMAScript 6 modules, which look like this:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// In './test_module.js':</span>

<span class="kr">export</span> <span class="kd">function</span> <span class="nx">Foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I'm Foo!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// In './test_default_module.js':</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I'm Bar!"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// In './test_importer.js':</span>

<span class="c1">// Import 'Foo' from './test_module.js'.</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">Foo</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">'./test_module'</span><span class="p">;</span>
<span class="c1">// Import the default export of './test_default_module.js'.</span>
<span class="kr">import</span> <span class="nx">Bar</span> <span class="nx">from</span> <span class="s1">'./test_default_module'</span><span class="p">;</span>

<span class="nx">Foo</span><span class="p">();</span> <span class="c1">// prints 'I'm Foo!'</span>
<span class="nx">Bar</span><span class="p">();</span> <span class="c1">// prints 'I'm Bar!'</span>
</code></pre>
</div>

<p>Node.JS came about <em>before</em> ECMAScript 6 modules, so it has its own module system called CommonJS. In CommonJS, a module has a magic object called <code class="highlighter-rouge">module.exports</code>. Anything you assign to this object gets “exported” on that module.</p>

<p>The above would be translated into CommonJS like so:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// In './test_module.js':</span>

<span class="kd">function</span> <span class="nx">Foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I'm Foo!"</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Export Foo as Foo.</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Foo</span> <span class="o">=</span> <span class="nx">Foo</span><span class="p">;</span>

<span class="c1">// In './test_default_module.js':</span>

<span class="kd">function</span> <span class="nx">Bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I'm Bar!"</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// A CommonJS "default" export merely overwrites the entire</span>
<span class="c1">// module.exports object.</span>
<span class="c1">//</span>
<span class="c1">// Unlike ECMAScript 6 modules, you cannot have default and</span>
<span class="c1">// non-default exports in the same module. `module.exports`</span>
<span class="c1">// is simply a JavaScript object.</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Bar</span><span class="p">;</span>

<span class="c1">// In './test_importer.js':</span>

<span class="c1">// Import 'Foo'</span>
<span class="kd">var</span> <span class="nx">TestModule</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./test_module'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Foo</span> <span class="o">=</span> <span class="nx">TestModule</span><span class="p">.</span><span class="nx">Foo</span><span class="p">;</span>
<span class="c1">// Import the default export of './test_default_module.js' module.</span>
<span class="kd">var</span> <span class="nx">Bar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./test_default_module'</span><span class="p">);</span>

<span class="nx">Foo</span><span class="p">();</span> <span class="c1">// prints 'I'm Foo!'</span>
<span class="nx">Bar</span><span class="p">();</span> <span class="c1">// prints 'I'm Bar!'</span>
</code></pre>
</div>

<p>Feel free to try out the above in the <code class="highlighter-rouge">server</code> folder. You don’t <em>have</em> to do this, but we recommend it.</p>

<p>If you create the three files, you can run them like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ node src/test_importer.js
I'm Foo!
I'm Bar!
</code></pre>
</div>

<h3 id="writing-and-debugging-a-program">Writing and Debugging a Program</h3>

<p>Let’s expand our <code class="highlighter-rouge">helloworld.js</code> program a bit. Let’s make it print out
<code class="highlighter-rouge">'Hello World!'</code> <em>backwards</em>! (<strong>You will have to do this part.</strong>)</p>

<p>Let’s write a routine in <code class="highlighter-rouge">src/util.js</code> that reverses the string. Create <code class="highlighter-rouge">src/util.js</code>, and include the following code to reverse the string:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">reverseString</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reversed</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">reversed</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">[</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">reversed</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">reverseString</span> <span class="o">=</span> <span class="nx">reverseString</span><span class="p">;</span>
</code></pre>
</div>

<p>Now, to test your knowledge: Using what you just learned about CommonJS modules, import <code class="highlighter-rouge">reverseString</code> into <code class="highlighter-rouge">src/helloworld.js</code>, and apply it to <code class="highlighter-rouge">"Hello World!"</code>. Then, <code class="highlighter-rouge">console.log</code> the result.</p>

<p>Your program should print the following:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">$</span> <span class="nx">node</span> <span class="nx">src</span><span class="o">/</span><span class="nx">helloworld</span><span class="p">.</span><span class="nx">js</span>
<span class="kc">undefined</span><span class="o">!</span><span class="nx">dlroW</span> <span class="nx">olle</span>
</code></pre>
</div>

<p>Uh oh! There’s a bug in our <code class="highlighter-rouge">reverseString</code> code! How can we debug this program?</p>

<p>Enter <a href="https://github.com/node-inspector/node-inspector">Node Inspector</a>! Simply run the program with <code class="highlighter-rouge">node-debug</code> instead:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">$</span> <span class="nx">node</span><span class="o">-</span><span class="nx">debug</span> <span class="nx">src</span><span class="o">/</span><span class="nx">helloworld</span><span class="p">.</span><span class="nx">js</span>
<span class="nx">Node</span> <span class="nx">Inspector</span> <span class="nx">is</span> <span class="nx">now</span> <span class="nx">available</span> <span class="nx">from</span> <span class="nx">http</span><span class="err">:</span><span class="c1">//127.0.0.1:8080/?ws=127.0.0.1:8080&amp;port=5858</span>
<span class="nx">Debugging</span> <span class="err">`</span><span class="nx">src</span><span class="o">/</span><span class="nx">helloworld</span><span class="p">.</span><span class="nx">js</span><span class="err">`</span>

<span class="nx">Debugger</span> <span class="nx">listening</span> <span class="nx">on</span> <span class="nx">port</span> <span class="mi">5858</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">node-debug</code> should open up Google Chrome automatically after a brief pause. Sometimes, though, it does not do this – especially on Mac :( . If it does not open Chrome, manually open Google Chrome, and go to the URL it printed to the terminal.</p>

<p>It will take a short bit before the interface pops up properly. Eventually, you’ll see the following:</p>

<p><img src="/workshops/images/node-inspector.png" alt="node-inspector" /></p>

<p>Node Inspector has created a <em>breakpoint</em> on your program’s first line, and so your program is paused at the first line of <code class="highlighter-rouge">helloworld.js</code>. Notice that your program looks a <em>little</em> different; it’s wrapped in a <code class="highlighter-rouge">function()</code>. Node Inspector is showing you a bit of Node.JS’s internal details; you can disregard this difference, as it doesn’t impact how the program runs!</p>

<p>Node Inspector’s interface should look familiar: It uses a version of Chrome’s Developer Tools that is modified to work with Node.JS.</p>

<p>Click on <code class="highlighter-rouge">util.js</code> in the <code class="highlighter-rouge">Sources</code> pane, and click on line number 2 to place a breakpoint on <code class="highlighter-rouge">var reversed = "";</code> (it will be a blue mark):</p>

<p><img src="/workshops/images/ni-breakpoint.png" alt="breakpoint" /></p>

<p>This will cause the program to pause when it runs <code class="highlighter-rouge">reverseString()</code>.</p>

<p>Then, click the “Resume Script Execution” button (which looks like a ‘Play’ button) to tell the program to resume running. It should immediately pause on your new breakpoint:</p>

<p><img src="/workshops/images/ni-rs-breakpoint.png" alt="breakpoint" /></p>

<p>Before proceeding, let’s look at some of the stuff in the right pane of Node Inspector. This is where Node Inspector / Chrome’s Development Tools shows your program’s current state:</p>

<p><img src="/workshops/images/ni-rightpane.png" alt="right pane" /></p>

<p><strong>Call Stack</strong>: Displays the <a href="https://en.wikipedia.org/wiki/Call_stack">Call Stack</a> of your paused program. In other words, it displays the trail of functions that called this function, along with their source location. If you click on any, Node-Inspector will take you to the line of the function that triggered the next in the stack.</p>

<p>You may notice some weird stuff in this call stack. <code class="highlighter-rouge">timers.js</code> and <code class="highlighter-rouge">module.js</code> are internal to Node.JS; once again, Node Inspector is showing you some of the “guts” of Node.JS. The real stuff starts above those stack frames, at <code class="highlighter-rouge">helloworld.js</code>.</p>

<p><strong>Scope Variables</strong>: Displays all of the variables in the <em>scope</em> of the currently selected stack frame. If you click on <code class="highlighter-rouge">reverseString</code> in “Call Stack”, it will contain the state of the <code class="highlighter-rouge">reversed</code> variable, the <code class="highlighter-rouge">i</code> variable, the <code class="highlighter-rouge">str</code> argument to <code class="highlighter-rouge">reverseString()</code>, and <code class="highlighter-rouge">this</code> – which points to the Global Scope. <code class="highlighter-rouge">reversed</code> and <code class="highlighter-rouge">i</code> are <code class="highlighter-rouge">undefined</code>, since the function hasn’t assigned any values to them yet.</p>

<p>If you click on “(anonymous function) helloworld.js” in “Call Stack”, “Scope Variables” will update to show you the variables within <code class="highlighter-rouge">helloworld.js</code> – including the imported modules!</p>

<p>Now, <strong>click on “Step Over” once</strong>, which is to the right of the resume button. This will cause the program to run the currently selected line (<code class="highlighter-rouge">reversed = ""</code>), and pause at the next line (the <code class="highlighter-rouge">for</code> loop).</p>

<p><img src="/workshops/images/StepOver.png" alt="stepover" /></p>

<p>If you click on <code class="highlighter-rouge">reverseString</code> in “Call Stack” and look at “Stack Variables”, you’ll see that <code class="highlighter-rouge">reversed</code> is now set to <code class="highlighter-rouge">""</code>. Great!</p>

<p>Watch <code class="highlighter-rouge">reversed</code>, and click on “Step Over” until you see it change to <code class="highlighter-rouge">"undefined"</code> – which is literally a <em>string</em> with the text “undefined”. This happens after the first iteration of the loop. That’s not right!</p>

<p><strong>Take a screenshot of node-inspector that clearly shows <code class="highlighter-rouge">reversed</code> set to the string “undefined”. Place it in your repository at <code class="highlighter-rouge">server/node_inspector_undefined.png</code>.</strong></p>

<p>Now, why did this happen? If you look at the other state, <code class="highlighter-rouge">i</code> is 0. We appended <code class="highlighter-rouge">str[str.length - i]</code> to <code class="highlighter-rouge">reversed</code>. Why was this <code class="highlighter-rouge">undefined</code>?</p>

<p>Make sure <code class="highlighter-rouge">reverseString</code> is still selected in “Call Stack”, and click on the “Show Drawer” button in the upper-right corner to show the console (if it’s not already there!):</p>

<p><img src="/workshops/images/ni-show-drawer.png" alt="show drawer" /></p>

<p><em>Note: When it turns blue like the screenshot, the console is open.</em></p>

<p>In the console, you can write JavaScript expressions that use the variables in the currently selected function in “Call Stack”! If you type <code class="highlighter-rouge">reversed</code> and hit enter, it will print the value of <code class="highlighter-rouge">reversed</code>:</p>

<p><img src="/workshops/images/ni-console.png" alt="console" /></p>

<p>Type <code class="highlighter-rouge">str[str.length - i]</code> into the console, and hit “Enter”…. and you’ll discover the problem. Since <code class="highlighter-rouge">i</code> is 0, we accessed <code class="highlighter-rouge">str[str.length]</code>. Since strings are 0-indexed, you access the first character at index 0, second at index 1, etc. Thus, the <em>last index</em> of a string is actually at <code class="highlighter-rouge">str.length - 1</code>.</p>

<p>Change <code class="highlighter-rouge">util.js</code> to fix this bug so that your program works propely:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ node src/helloworld.js
!dlroW olleH
</code></pre>
</div>

<p><strong><code class="highlighter-rouge">add</code> <code class="highlighter-rouge">server/src/util.js</code> <code class="highlighter-rouge">server/src/helloworld.js</code> <code class="highlighter-rouge">server/node_inspector_undefined.png</code> to the repository, <code class="highlighter-rouge">commit</code> them with message <code class="highlighter-rouge">node</code>, and <code class="highlighter-rouge">push</code> the commit to GitHub.</strong></p>

<h2 id="express-introduction">Express Introduction</h2>

<p>Express is a Node.JS module that makes it easy to write web servers. You installed it when you ran <code class="highlighter-rouge">npm install</code> in the <code class="highlighter-rouge">server</code> directory.</p>

<p><a href="http://expressjs.com/">Express has really good documentation.</a> There are many Guides under the “Guide” section on that page, <a href="http://expressjs.com/en/4x/api.html">a full API reference in the “API” section</a> (we’ll be using version 4 in this class), and more!</p>

<h3 id="hello-world-1">Hello World!</h3>

<p>Create the file <code class="highlighter-rouge">src/server.js</code> with the following code:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Imports the express Node module.</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="c1">// Creates an Express server.</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Defines what happens when it receives the `GET /` request</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'Hello World!'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Starts the server on port 3000!</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Example app listening on port 3000!'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Run the server in the terminal:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ node src/server.js
Example app listening on port 3000!
</code></pre>
</div>

<p>Open up your webbrowser to <code class="highlighter-rouge">http://localhost:3000/</code>, and you’ll be greeted to “Hello World!”.</p>

<h3 id="send-http-requests-with-postman">Send HTTP Requests with Postman</h3>

<p>With your example server still running, open up Postman. If you installed it as a Chrome App, open up Chrome to chrome://apps and click on Postman. If you installed it as a standalone application, it’s likely in the same place you find the rest of your programs on your operating system.</p>

<p>Postman may ask you to sign in or make an account, but you don’t have to create an account to use Postman; there is a link to continue to the application at the bottom of the sign-in page you can click instead.</p>

<p>Postman may look a little intimidating at first, but its core functionality is in a simple form at the center:</p>

<p><img src="/workshops/images/postman-interface.png" alt="postman interface" /></p>

<p>Type <code class="highlighter-rouge">http://localhost:3000</code> into the “Request URL” box, keep the verb at GET, and click “Send”. Postman will display the response below your request:</p>

<p><img src="/workshops/images/postman-response.png" alt="postman response" /></p>

<p>If you click on “Headers”, you can see all of the metadata that your Express server sent along with the response. You can also see the response code in the upper right corner (in blue, next to “Status”).</p>

<p>You don’t need to memorize any of these details, but I’ll explain each part of the header anyway:</p>

<ul>
  <li>Connection: keep-alive
    <ul>
      <li>In ye olden days, every HTTP request was sent on an independent TCP socket, which isn’t very efficient. Modern servers, like Express, let clients keep a single socket open to send and receive multiple HTTP requests and responses over a single TCP socket.</li>
    </ul>
  </li>
  <li>Content-Length: 12
    <ul>
      <li>The <em>body</em> of the response is 12 bytes long. “Hello World!” is 12 characters long, with every character a single byte long.</li>
    </ul>
  </li>
  <li>Content-Type: text/html; charset=utf-8
    <ul>
      <li>Translation: The <em>body</em> of the response is either text or HTML, and it uses UTF-8 encoding. (remember how we discussed UTF-8/character encoding briefly in the HTML workshop? No? Then don’t worry too much; just know that UTF-8 is typically the right choice.)</li>
      <li>This is called the <a href="https://en.wikipedia.org/wiki/Media_type">Media Type</a>, or MIME type, of the response. It tells the client how to interpret the body.</li>
    </ul>
  </li>
  <li>Date: (Contains a date and time)
    <ul>
      <li>The time and date that the server sent the response.</li>
    </ul>
  </li>
  <li>ETag: W/”c-7Qdih1MuhjZehB6Sv8UNjA”
    <ul>
      <li><a href="https://en.wikipedia.org/wiki/HTTP_ETag">Used by web caches.</a> Typically, if two responses contain the same etag, then they are identical.</li>
      <li>You can get the etag of a response without the response itself using the <code class="highlighter-rouge">HEAD</code> verb (go ahead, try it in Postman!) Notice how it doesn’t change across requests – since your response is always “Hello World!”.</li>
      <li>Thought experiment: Imagine if the response was multiple megabytes in size – e.g. an MP3 file. Now imagine you are implementing a web cache for the CS department (we have one!), and 100 students in the CS department are trying to download this MP3 file. Can you imagine how you might use the etag and <code class="highlighter-rouge">HEAD</code> to check if it’s valid to serve a cached version of the MP3, saving the department $$ on internet costs?</li>
    </ul>
  </li>
  <li>X-Powered-By: Express
    <ul>
      <li>Contains what server/application sent the response. Completely meaningless, really, but most HTTP responses contain it.</li>
    </ul>
  </li>
</ul>

<p>By the way, if you want to see something funny, try running <code class="highlighter-rouge">GET</code> on <code class="highlighter-rouge">http://reddit.com/</code> in Postman, and check the “Headers” field for <code class="highlighter-rouge">x-moose</code>. Since you can include arbitrary data in the Headers section, web developers sometimes include fun easter eggs.</p>

<p>If you try to send a request to your Express server for a route that you haven’t configured, like <code class="highlighter-rouge">PUT http://localhost:3000/</code>, you’ll receive a “404 Not Found”.</p>

<h3 id="lets-post-stuff">Let’s POST stuff!</h3>

<p>Now that we have a simple Express application, let’s write a <code class="highlighter-rouge">POST</code> resource at <code class="highlighter-rouge">/reverse</code> that reverses the contents of whatever you POST to it!</p>

<p>In <code class="highlighter-rouge">src/server.js</code>, import <code class="highlighter-rouge">reverseString</code> from <code class="highlighter-rouge">util.js</code> (remember to import it the CommonJS way!). Then, add the following code:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Handle POST /reverse [data]</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/reverse'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// How do we get the input text?</span>
  <span class="c1">// How do we send the output text?</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The two input arguments to the function above, <code class="highlighter-rouge">req</code> and <code class="highlighter-rouge">res</code>, refer to the HTTP request and the HTTP response. Express has detailed documentation for both the <a href="http://expressjs.com/en/4x/api.html#req">Request</a> and the <a href="http://expressjs.com/en/4x/api.html#res">Response</a> objects.</p>

<p>We need to get the body of the HTTP request, which will be a string to reverse. The documentation for <a href="http://expressjs.com/en/4x/api.html#req.body"><code class="highlighter-rouge">req.body</code></a> states we need additional software to handle the <code class="highlighter-rouge">body</code>:</p>

<blockquote>
  <p>Contains key-value pairs of data submitted in the request body. By default, it is <code class="highlighter-rouge">undefined</code>,
and is populated when you use body-parsing middleware such as <code class="highlighter-rouge">body-parser</code> and <code class="highlighter-rouge">multer</code>.</p>
</blockquote>

<p>The <code class="highlighter-rouge">body</code> of a request or a response can contain arbitrary data. While you will typically use text or JSON in this class, the <code class="highlighter-rouge">body</code> can also contain a JPEG photo, a movie, a CSV file, or anything else you want. Thus, you may want <code class="highlighter-rouge">req.body</code> to be handled differently depending on what the data is.</p>

<p>Express has no opinion regarding how you should handle <code class="highlighter-rouge">body</code>, and lets you choose what middleware to use. For this workshop, we will use the <a href="https://www.npmjs.com/package/body-parser"><code class="highlighter-rouge">body-parser</code> library</a>; you’ll likely want to use it in your startup projects, too!</p>

<p>Like with Express, you already installed <code class="highlighter-rouge">body-parser</code> when you ran <code class="highlighter-rouge">npm install</code> earlier. Import <code class="highlighter-rouge">body-parser</code> into <code class="highlighter-rouge">server.js</code> with the following code:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'body-parser'</span><span class="p">);</span>
</code></pre>
</div>

<p>Now, tell your app to <a href="https://www.npmjs.com/package/body-parser#bodyparsertextoptions">use <code class="highlighter-rouge">body-parser</code>’s <code class="highlighter-rouge">text</code> middleware, which handles requests that self-identify as <code class="highlighter-rouge">text</code></a> (using the <code class="highlighter-rouge">Content-Type</code> field in the HTTP Request’s Header, which contains a Media type):</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>
</code></pre>
</div>

<p>Now, you can complete your <code class="highlighter-rouge">POST</code> function!</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Handle POST /reverse [data]</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/reverse'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If the request came with text, then the text() middleware handled it</span>
  <span class="c1">// and made `req.body` a string.</span>
  <span class="c1">// Check that req.body is a string.</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">reversed</span> <span class="o">=</span> <span class="nx">reverseString</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">reversed</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// POST did not contain a string. Send an error code back!</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The code above raises a question: How do we send an <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">HTTP error status code back</a>? <a href="http://expressjs.com/en/4x/api.html#res.status"><code class="highlighter-rouge">res.status(statuscode)</code></a> is the answer. As for the status code to use… we should use <code class="highlighter-rouge">400</code>: Bad Request as the status code, which Wikipedia describes as:</p>

<blockquote>
  <p><strong>400 Bad Request</strong></p>

  <p>The server cannot or will not process the request due to an apparent client error (e.g., malformed request syntax,
invalid request message framing, or deceptive request routing)</p>
</blockquote>

<p>In this case, the <em>request syntax</em> is <em>malformed</em>, as it does not contain a string in the body. Add <code class="highlighter-rouge">res.status(400).end()</code> to the <code class="highlighter-rouge">else</code> branch above.</p>

<p>Open up the terminal you’ve been using to run your server. If it’s still running from earlier, kill it with CTRL+C, and re-run it so it pulls in the edits we just made. <strong>Node will not pull in code changes automatically into a running server; you always need to kill and re-run the server when you change its code.</strong></p>

<p>Open up Postman, and tell it to <code class="highlighter-rouge">POST http://localhost:3000/reverse</code> with some text. You can edit the Body of the response by clicking on the “Body” section just below the URL entry box:</p>

<p><img src="/workshops/images/postman-body.png" alt="postman body" /></p>

<p>With “body” selected, click on “raw” to tell Postman that you’re editing the raw contents of the body (it defaults to <code class="highlighter-rouge">form-data</code>, which auto-formats the body like <a href="https://en.wikipedia.org/wiki/MIME#Form-Data">an oldschool HTML form submission</a>). Enter a string, then hit SEND.</p>

<p>You should see a response from the server with the reversed string. Hurray! If you don’t enter a string (e.g. a blank body), you should receive a “400 Bad Request”.</p>

<p><strong>Take a screenshot of Postman that shows your request and the server’s response, and include it as <code class="highlighter-rouge">server/postman_screenshot.png</code>.</strong></p>

<p><strong><code class="highlighter-rouge">add</code> <code class="highlighter-rouge">server/src/server.js</code> and <code class="highlighter-rouge">server/postman_screenshot.png</code> to the repository, <code class="highlighter-rouge">commit</code> with message <code class="highlighter-rouge">express</code>, and <code class="highlighter-rouge">push</code> it to GitHub.</strong></p>

<p>You’re ready to start writing Facebook’s server!</p>

<h1 id="writing-a-server-for-facebook">Writing a Server for Facebook</h1>

<p><em>Note: If you skipped the previous sections, you’re doing this workshop incorrectly; by now, you should have made two commits that we will grade you on, and should have recorded an answer somewhere to two sets of questions. :)</em></p>

<p>From the previous sections, we know:</p>

<ul>
  <li>How to write webservers using Express</li>
  <li>What HTTP routes we need to define for Facebook, and what verbs they need to support</li>
  <li>How to debug the server using Node Inspector</li>
  <li>How to test the server’s routes using Postman</li>
</ul>

<p>You are totally ready to work on Facebook’s server!</p>

<h2 id="setup-1">Setup</h2>

<p>Open up a terminal to the <strong>git repository folder</strong> for this workshop, and run
the following commands:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd client
$ npm install
$ npm run watch
</code></pre>
</div>

<p>Note that the last command is <em>different</em> from before it uses <code class="highlighter-rouge">watch</code>, not <code class="highlighter-rouge">serve</code>!
<code class="highlighter-rouge">npm run serve</code> rebuilds your code as it changes, <em>and</em> creates a dumb webserver that serves up the files in <code class="highlighter-rouge">build/</code>. Your Express server in <code class="highlighter-rouge">server</code> will take the place of this dumb webserver, so we no longer need it. <code class="highlighter-rouge">npm run watch</code> will only rebuild your code as it changes.</p>

<p>Keep this terminal open and running throughout the rest of the workshop.</p>

<p><em>Note: If you still have a terminal open running <code class="highlighter-rouge">npm run serve</code> from earlier, you can close it / kill the server. We no longer need it.</em></p>

<h2 id="serve-up-html-css-and-javascript">Serve up HTML, CSS, and JavaScript</h2>

<p>Our webserver needs to serve our HTML, CSS, JavaScript, and image files from <code class="highlighter-rouge">client/build</code>. Otherwise, a web browser will not be able to load our webpage!</p>

<p>Express has <a href="http://expressjs.com/en/starter/static-files.html">handy APIs for serving up static files from the file system</a>.
Simply add the followling line to <code class="highlighter-rouge">src/server.js</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// You run the server from `server`, so `../client/build` is `server/../client/build`.</span>
<span class="c1">// '..' means "go up one directory", so this translates into `client/build`!</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">'../client/build'</span><span class="p">));</span>
</code></pre>
</div>

<p>Remove the two routes we defined previously for <code class="highlighter-rouge">/</code> and <code class="highlighter-rouge">/reverse</code>, as we no longer need them. Then, open up a terminal to the <code class="highlighter-rouge">server</code> folder in the <em>git repository folder</em>, and run the server with <code class="highlighter-rouge">node src/server.js</code>. If you open your web browser to http://localhost:3000/, you’ll see the Facebook mockup!</p>

<p><strong><code class="highlighter-rouge">commit</code> this change with message <code class="highlighter-rouge">static</code>, and <code class="highlighter-rouge">push</code> it to GitHub.</strong></p>

<h2 id="migrate-data-to-mock-database-on-server">Migrate Data to Mock Database on Server</h2>

<p>The first step is simple: Copy+paste the <em>objects</em> from <code class="highlighter-rouge">initialData</code> in <code class="highlighter-rouge">client/app/database.js</code> to <code class="highlighter-rouge">initialData</code> in <code class="highlighter-rouge">server/src/database.js</code>. (Don’t simply overwrite the entire <code class="highlighter-rouge">database.js</code> file; the rest of the Node.js <code class="highlighter-rouge">database.js</code> is slightly different!)</p>

<p>Now, your database is all set for the server!</p>

<p><em>NOTE: Due to an oversight, the Workshop 6 repository already contains this change. Instead of doing the copy+paste, simply add a new line to <code class="highlighter-rouge">server/src/database.js</code> to indicate that you read this section, and commit that as your change.</em></p>

<p><strong><code class="highlighter-rouge">commit</code> this change with message <code class="highlighter-rouge">database</code>, and <code class="highlighter-rouge">push</code> it to GitHub.</strong></p>

<h2 id="implement-a-single-route-on-the-server">Implement a single route on the server</h2>

<p>Let’s migrate the <code class="highlighter-rouge">getFeedData</code> function from the client to the server. Literally copy the functions <code class="highlighter-rouge">getFeedData</code> and <code class="highlighter-rouge">getFeedItemSync</code> from the client’s <code class="highlighter-rouge">server.js</code>, and paste them into the server’s <code class="highlighter-rouge">server.js</code>.  Change <code class="highlighter-rouge">getFeedData</code> so it simply <code class="highlighter-rouge">return</code>s the resolved FeedData object; there’s no need to emulate a server return anymore, as all of this code is running on the server!</p>

<p>You will also need to import the database function <code class="highlighter-rouge">readDocument</code>. Remember to use CommonJS syntax!</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Resolves a feed item. Internal to the server, since it's synchronous.
 */</span>
<span class="kd">function</span> <span class="nx">getFeedItemSync</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">feedItem</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
  <span class="c1">// Resolve 'like' counter.</span>
  <span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span> <span class="o">=</span> <span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> 
                            <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">id</span><span class="p">));</span>
  <span class="c1">// Assuming a StatusUpdate. If we had other types of </span>
  <span class="c1">// FeedItems in the DB, we would</span>
  <span class="c1">// need to check the type and have logic for each type.</span>
  <span class="nx">feedItem</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> 
	                                      <span class="nx">feedItem</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">author</span><span class="p">);</span>
  <span class="c1">// Resolve comment author.</span>
  <span class="nx">feedItem</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">comment</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">comment</span><span class="p">.</span><span class="nx">author</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">author</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">feedItem</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * Get the feed data for a particular user.
 */</span>
<span class="kd">function</span> <span class="nx">getFeedData</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">userData</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">feedData</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">,</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">feed</span><span class="p">);</span>
  <span class="c1">// While map takes a callback, it is synchronous, </span>
  <span class="c1">// not asynchronous. It calls the callback immediately.</span>
  <span class="nx">feedData</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="nx">feedData</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">getFeedItemSync</span><span class="p">);</span>
  <span class="c1">// Return FeedData with resolved references.</span>
  <span class="k">return</span> <span class="nx">feedData</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now, we can define a route that gets the feed data. Recall that we decided that this function would map to <code class="highlighter-rouge">GET /user/:userid/feed</code>. Express supports URL parameters in a similar way as React Router, using a colon (<code class="highlighter-rouge">:</code>) to indicate variables in the URL:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Get the feed data for a particular user.
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/user/:userid/feed'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// URL parameters are stored in req.params</span>
  <span class="kd">var</span> <span class="nx">userid</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userid</span><span class="p">;</span>
  <span class="c1">// Send response.</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">getFeedData</span><span class="p">(</span><span class="nx">userid</span><span class="p">));</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Re-run your server, and run <code class="highlighter-rouge">GET http://localhost:3000/user/4/feed</code> in Postman. You should see a JSON object with the feed data. Awesome!</p>

<p>Our web server should only respond with a user’s feed item if that user is requesting it.  In other words, user Bob shouldn’t be able to see user Sarah’s Facebook feed!</p>

<p>As mentioned previously, we will eventually use legitimate JSON web tokens for authentication, which uses encryption to verify the token’s authenticity. For now, though, we’ll simply blindly trust unencrypted tokens that the client gives us, and use those to check permissions.</p>

<p>JSON web tokens (and other types of tokens!) are sent in the <code class="highlighter-rouge">Authorization</code> field in the HTTP Request’s Header, with the value:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Authorization: Bearer &lt;token&gt;
</code></pre>
</div>

<p>To make a token out of a JSON object, we’ll
simply <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify">stringify the JSON object</a> and <a href="https://en.wikipedia.org/wiki/Base64">use base 64 encoding</a> to turn it into a string we can put into the header. You don’t need to know much about base64; just know that it’s a convenient way to turn arbitrary data into a string that only contains letters and numbers.</p>

<p>Example: The JavaScript object <code class="highlighter-rouge"><span class="p">{</span><span class="err">foo:</span><span class="w"> </span><span class="err">3</span><span class="p">}</span></code> gets turned into the JSON string <code class="highlighter-rouge">'{"foo": 3}'</code>, and conversion to base64 changes it into a string with only letters and numbers (and, sometimes, the equals sign <code class="highlighter-rouge">=</code> at the end).</p>

<p>We can use
<a href="http://expressjs.com/en/4x/api.html#req.get"><code class="highlighter-rouge">req.get('Authorization')</code></a> to retrieve the “Authorization” header field, use <a href="https://nodejs.org/dist/latest-v4.x/docs/api/buffer.html">NodeJS’s Buffer API</a> to <a href="http://stackoverflow.com/a/6182519">translate the base64 string into a regular string</a>, and then use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse"><code class="highlighter-rouge">JSON.parse()</code></a> to turn the string into a JavaScript object. Should any of this fail, the user is not authorized.</p>

<p>Modify <code class="highlighter-rouge">src/server.js</code> with the following code:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Get the user ID from a token. Returns -1 (an invalid ID) 
 * if it fails.
 */</span>
<span class="kd">function</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">authorizationLine</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Cut off "Bearer " from the header value.</span>
    <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">authorizationLine</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
    <span class="c1">// Convert the base64 string to a UTF-8 string.</span>
    <span class="kd">var</span> <span class="nx">regularString</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="s1">'base64'</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'utf8'</span><span class="p">);</span>
    <span class="c1">// Convert the UTF-8 string into a JavaScript object.</span>
    <span class="kd">var</span> <span class="nx">tokenObj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">regularString</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">tokenObj</span><span class="p">[</span><span class="s1">'id'</span><span class="p">];</span>
    <span class="c1">// Check that id is a number.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">id</span> <span class="o">===</span> <span class="s1">'number'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">id</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Not a number. Return -1, an invalid ID.</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Return an invalid ID.</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**
 * Get the feed data for a particular user.
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/user/:userid/feed'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">userid</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userid</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>
  <span class="c1">// userid is a string. We need it to be a number.</span>
  <span class="c1">// Parameters are always strings.</span>
  <span class="kd">var</span> <span class="nx">useridNumber</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">userid</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fromUser</span> <span class="o">===</span> <span class="nx">useridNumber</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Send response.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">getFeedData</span><span class="p">(</span><span class="nx">userid</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 401: Unauthorized request.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>After making these changes, re-run the server. Try to <code class="highlighter-rouge">GET /user/4/feed</code> in Postman; you will get a “401 Unauthorized”. In another terminal, run <code class="highlighter-rouge">node</code> (no arguments) to open up the Node REPL. A REPL lets you type code, which immediately runs and prints a response. The console in Chrome’s Web Development Tools is a REPL; when you used Node Inspector to debug a program earlier, you typed in lines of code and it printed the result!</p>

<p>Type the following into the REPL, and hit Enter to generate a token for user 4:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="mi">4</span> <span class="p">})).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">);</span>
</code></pre>
</div>

<p>This one-liner will:</p>

<ul>
  <li>Convert the JavaScript object <code class="highlighter-rouge"><span class="p">{</span><span class="w"> </span><span class="err">id:</span><span class="w"> </span><span class="err">4</span><span class="w"> </span><span class="p">}</span></code> to a JSON string.</li>
  <li>Place that JSON string into a NodeJS Buffer object.</li>
  <li>Convert the Buffer into base64 encoding.</li>
</ul>

<p>In Postman, click on the “Headers” tab for your request. Add a header for “Authorization” with the value “Bearer [token here]” – for example, “Bearer ubBbsf4==” – using the token that you just received on the command line. Then, click Send. It should give you back the feed for user 4!</p>

<p><strong><code class="highlighter-rouge">commit</code> this change with message <code class="highlighter-rouge">getFeedData</code>, and <code class="highlighter-rouge">push</code> it to GitHub</strong></p>

<h2 id="communicating-with-the-server-from-the-client">Communicating with the Server from the Client</h2>

<p>Now that we have server support for <code class="highlighter-rouge">getFeedData</code>, we will modify the client to use this new server method. Web browsers have an API called <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest">XMLHttpRequest</a> that facilitates communicating with web servers like this.</p>

<p>Aside: <code class="highlighter-rouge">XMLHttpRequest</code> is a weird name for this API. The name is a remnant of the bad old days, when Internet Explorer implemented the interface as a way for Outlook Web Access to fetch XML documents using HTTP requests. Others discovered it, Firefox implemented it, and now it’s used to perform any type of HTTP request… but the confusing name remains!</p>

<p>Let’s walk through using it to send a request to <code class="highlighter-rouge">/user/4/feed</code>!</p>

<p>First, create an <code class="highlighter-rouge">XMLHttpRequest</code> object:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
</code></pre>
</div>

<p>Then, <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest#open()">call <code class="highlighter-rouge">open()</code></a>
on the object with the HTTP verb and target URL.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/user/4/feed'</span><span class="p">);</span>
</code></pre>
</div>

<p>Next, use <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest#setRequestHeader\(\)"><code class="highlighter-rouge">setRequestHeader</code></a> to set ‘Authorized’ to the base64 token you generated:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">,</span> <span class="s1">'Bearer jsontokenhere'</span><span class="p">);</span>
</code></pre>
</div>

<p>Next, attach an event listener, which will fire when the server sends a response to our request. At that time, the response body will be available on the <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/responseText">responseText property</a> of the XMLHttpRequest object:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'load'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Call the callback with the data.</span>
  <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Finally, use <code class="highlighter-rouge">send()</code> to send the request over the network!</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
</code></pre>
</div>

<p>Put it all together, and use it to replace <code class="highlighter-rouge">getFeedData</code> in <code class="highlighter-rouge">app/server.js</code>. Make sure you still have <code class="highlighter-rouge">npm run watch</code> running in the <code class="highlighter-rouge">client</code> folder, and navigate your web browser to <code class="highlighter-rouge">http://localhost:3000/</code>. Facebook should still work as before.</p>

<p>How do you know that it’s working, though? If you open up Chrome Devtools, click on the ‘Network’ tab, and refresh the page, you should see <code class="highlighter-rouge">feed</code> in the entry of the list of Network Requests:</p>

<p><img src="/workshops/images/devtools-network-feed.png" alt="devtools network feed" /></p>

<p>If you do not see <code class="highlighter-rouge">feed</code> there, Chrome may be using a cached version of your Facebook mockup. Check the “Disable cache” checkbox on the network tab, and reload the page. That should fix the issue. Note that the “Disable cache” option is only active when you have Chrome’s development tools open.</p>

<p><strong><code class="highlighter-rouge">commit</code> your changes with message <code class="highlighter-rouge">facebookGotServed</code> and <code class="highlighter-rouge">push</code> it to GitHub.</strong></p>

<h2 id="handling-http-requests-that-fail">Handling HTTP Requests That Fail</h2>

<p>The above code works great when a request succeeds, but it does not handle scenarios where a request fails. There are three primary types of failures: Network failures, client errors, and server errors.</p>

<p><strong>Network Failures:</strong> The client cannot reach the server, at all. The request will time out, with no response from the server. Some plausible reasons include…</p>

<ul>
  <li><strong>The server chose not to respond, or did not respond due to developer error.</strong> If you write an Express route that <em>never</em> calls <code class="highlighter-rouge">res.send()</code>, then the client will never receive a response.</li>
  <li><strong>The client is not connected to the internet.</strong> On a laptop, this happens frequently when closing the laptop and re-opening it again later. On a phone, this can happen when moving between WiFi and your cell carrier’s wireless data network… or moving between two WiFi hotspots.</li>
  <li><strong>The server is down.</strong> Maybe you had to take the server down for maintainence?</li>
  <li><strong>There’s a network problem between the client and server.</strong> There’s a lot going on on the internet, and sometimes the route between the client and the server gets congested or goes down. Heck, in San Francisco, some group has <a href="http://www.nytimes.com/2015/11/08/sunday-review/the-cyberthreat-under-the-street.html?_r=0">cut 16 fiber optic cables in the past year</a>. Things happen.</li>
  <li><strong>The server is malfunctioning or overloaded.</strong> Ever see the <a href="http://www.yiyinglu.com/?portfolio=lifting-a-dreamer-aka-twitter-fail-whale">Twitter fail whale?</a> This would happen when Twiters services were either overloaded or malfunctioning; they simply could not send HTTP responses in a timely fashion.</li>
</ul>

<p><strong>Client errors:</strong> The server responded, but denied the request. The Status Code <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#4xx_Client_Error">will be in the 400-499 range</a>. The previous link includes a list of status codes, which covers reasons why a request may not be granted. All client errors are the result of an invalid client request (e.g. a request that is not authorized, or the request involves a resource that does not exist).</p>

<p><strong>Server errors:</strong> The server responded, but claims that it is <em>unable to</em> service the request. There is nothing wrong with the client’s request; the server is having a problem, and is unable to respond to it. <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#5xx_Server_Error">The Status Code will be in the 500-599 range</a>. Error code 500, “Internal Server Error”, is the error you will most likely see.</p>

<p>In this class, your server should send a 500 to the client when:</p>

<ul>
  <li><strong>Your server’s JavaScript has an error.</strong> Express automatically responds with <code class="highlighter-rouge">500</code> if your code throws an uncaught exception. We haven’t talked much about JavaScript exceptions, but you’ve likely seen them in the Chrome Web Developer console in red.</li>
  <li><strong>The database is not responding / not running.</strong> We’re using a mock database that’s embedded with the server right now, but we will later switch to MongoDB. If your database is not responding to requests, or is responding with an error, you should send a <code class="highlighter-rouge">500</code> to the client.</li>
  <li><strong>Requests to an external service your server is interacting with is failing.</strong> If your startup project’s server interacts with another service, and that service fails, you should send a <code class="highlighter-rouge">500</code> to the client.</li>
</ul>

<p>Learning how to catch these errors and report them will be good for your user, and will be good for you as a developer – otherwise, you may never see the failure at all!</p>

<p>The <strong>bare minimum</strong> amount of error handling we should do is surface the error so the user knows that something has gone wrong. Let’s add code to the client to display these failures. We will add a <a href="http://getbootstrap.com/components/#alerts-examples">Bootstrap “Warning” alert above Facebook’s three-column layout</a> to display any server issues. We will tell the user to try reloading the webpage. We will also install a <strong>global function</strong>, callable from anywhere, that lets code display information in this alert box.</p>

<p>In the client, add <code class="highlighter-rouge">app/components/errorbanner.js</code> with the following code:</p>

<p><em>Note: Due to an oversight, your workshop 6 repository already contains this file. You do not need to change it.</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">hideElement</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">'../util'</span><span class="p">;</span>

<span class="cm">/**
 * A yellow error banner that uses Bootstrap's "warning" alert. 
 * Used to display HTTP request failures.
 */</span>
<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">ErrorBanner</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">active</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">errors</span><span class="p">:</span> <span class="s2">""</span>
    <span class="p">};</span>

    <span class="c1">// ASSUMPTION: There is only one ErrorBanner component ever created.</span>
    <span class="c1">// (Otherwise, each will overwrite one another's global function...)</span>
    <span class="c1">// By assigning to 'window', this is a global function. Global functions</span>
    <span class="c1">// are not typically a good idea, but they can be useful for adding basic</span>
    <span class="c1">// error handling to an application</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">FacebookError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">errorText</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
        <span class="na">active</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">error</span><span class="p">:</span> <span class="nx">errorText</span>
      <span class="p">})</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Don't display the error banner unless 'this.state.active' is true.</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="s2">"alert alert-warning "</span> <span class="o">+</span> <span class="nx">hideElement</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">active</span><span class="p">)}</span> 
		   <span class="nx">role</span><span class="o">=</span><span class="s2">"alert"</span><span class="o">&gt;</span>
        <span class="nx">Facebook</span> <span class="nx">was</span> <span class="nx">unable</span> <span class="nx">to</span> <span class="nx">complete</span> <span class="nx">a</span> <span class="nx">recent</span> 
		<span class="nx">request</span><span class="err">:</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="p">}</span><span class="o">&lt;</span><span class="nx">br</span> <span class="o">/&gt;</span>
        <span class="nx">Please</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">()}</span><span class="o">&gt;</span>
		<span class="nx">refresh</span> <span class="nx">the</span> <span class="nx">web</span> <span class="nx">page</span><span class="o">&lt;</span><span class="sr">/a&gt; and try again</span><span class="err">.
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In <code class="highlighter-rouge">app/app.js</code>, add code that <code class="highlighter-rouge">imports ErrorBanner from './components/errorbanner'</code>, and then change the <code class="highlighter-rouge">render()</code> function of <code class="highlighter-rouge">App</code> to render an error banner:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// If there's no query input to this page (e.g. /foo instead of /foo?bar=4),</span>
    <span class="c1">// query may be undefined. We have to check for this, otherwise</span>
    <span class="c1">// JavaScript will throw an exception and die!</span>
    <span class="kd">var</span> <span class="nx">queryVars</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">searchTerm</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">queryVars</span> <span class="o">&amp;&amp;</span> <span class="nx">queryVars</span><span class="p">.</span><span class="nx">searchTerm</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">searchTerm</span> <span class="o">=</span> <span class="nx">queryVars</span><span class="p">.</span><span class="nx">searchTerm</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">NavBar</span> <span class="nx">searchTerm</span><span class="o">=</span><span class="p">{</span><span class="nx">searchTerm</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"row"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"col-md-12"</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">ErrorBanner</span> <span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>          <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>          <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"row"</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"col-md-2 fb-left-sidebar"</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">LeftSideBar</span> <span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"col-md-7"</span><span class="o">&gt;</span>
              <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">}</span>
            <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>            <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"col-md-3 fb-right-sidebar"</span><span class="o">&gt;</span>
              <span class="o">&lt;</span><span class="nx">RightSideBar</span> <span class="o">/&gt;</span>
            <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>          <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">ChatPopup</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">)</span>
  <span class="p">}</span>
</code></pre>
</div>

<p>Finally, in <code class="highlighter-rouge">server.js</code>, we’ll introduce a helper function that sets up an XHR request, and appropriately displays errors when they happen. Make sure you put your token from earlier into the code!</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span> <span class="c1">// &lt;-- Put your base64'd JSON token here</span>
<span class="cm">/**
 * Properly configure+send an XMLHttpRequest with error handling, 
 * authorization token, and other needed properties.
 */</span>
<span class="kd">function</span> <span class="nx">sendXHR</span><span class="p">(</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">resource</span><span class="p">);</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">,</span> <span class="s1">'Bearer '</span> <span class="o">+</span> <span class="nx">token</span><span class="p">);</span>

  <span class="c1">// The below comment tells ESLint that FacebookError is a global.</span>
  <span class="c1">// Otherwise, ESLint would complain about it! (See what happens in Atom if</span>
  <span class="c1">// you remove the comment...)</span>
  <span class="cm">/* global FacebookError */</span>

  <span class="c1">// Response received from server. It could be a failure, though!</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'load'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">statusText</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">statusText</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">statusCode</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">statusCode</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Success: Status code is in the [200, 300) range.</span>
      <span class="c1">// Call the callback with the final XHR object.</span>
      <span class="nx">cb</span><span class="p">(</span><span class="nx">xhr</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Client or server error.</span>
      <span class="c1">// The server may have included some response text with details concerning</span>
      <span class="c1">// the error.</span>
      <span class="kd">var</span> <span class="nx">responseText</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
      <span class="nx">FacebookError</span><span class="p">(</span><span class="s1">'Could not '</span> <span class="o">+</span> <span class="nx">verb</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nx">resource</span> <span class="o">+</span> <span class="s2">": Received "</span> <span class="o">+</span> 
		            <span class="nx">statusCode</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nx">statusText</span> <span class="o">+</span> <span class="s2">": "</span> <span class="o">+</span> <span class="nx">responseText</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Time out the request if it takes longer than 10,000 </span>
  <span class="c1">// milliseconds (10 seconds)</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

  <span class="c1">// Network failure: Could not connect to server.</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">FacebookError</span><span class="p">(</span><span class="s1">'Could not '</span> <span class="o">+</span> <span class="nx">verb</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nx">resource</span> <span class="o">+</span> 
	              <span class="s2">": Could not connect to the server."</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="c1">// Network failure: request took too long to complete.</span>
  <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'timeout'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">FacebookError</span><span class="p">(</span><span class="s1">'Could not '</span> <span class="o">+</span> <span class="nx">verb</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="nx">resource</span> <span class="o">+</span> 
		          <span class="s2">": Request timed out."</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="k">switch</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'undefined'</span><span class="p">:</span>
      <span class="c1">// No body to send.</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'string'</span><span class="p">:</span>
      <span class="c1">// Tell the server we are sending text.</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/plain;charset=UTF-8"</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s1">'object'</span><span class="p">:</span>
      <span class="c1">// Tell the server we are sending JSON.</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"application/json;charset=UTF-8"</span><span class="p">);</span>
      <span class="c1">// Convert body into a JSON string.</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default</span><span class="p">:</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Unknown body type: '</span> <span class="o">+</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now, change <code class="highlighter-rouge">getFeedData</code> to use this function:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Emulates a REST call to get the feed data for a particular user.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">getFeedData</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// We don't need to send a body, so pass in 'undefined' for the body.</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'/user/4/feed'</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Call the callback with the data.</span>
    <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now that you’ve made these changes, you should test that it all works. <strong>Induce one of the error conditions above and take a screenshot of Facebook with ErrorBanner displayed.</strong></p>

<p>How can you induce an error? Here are some suggestions:</p>

<ul>
  <li>For the <strong>timeout</strong>, remove the call to <code class="highlighter-rouge">res.send()</code> from the server that sends Feed data to the client. It will take 10 seconds for the timeout to occur.</li>
  <li>For the <strong>network failure</strong>, load Facebook, shut down the web server, and then try to delete a Facebook post. (Deleting a Facebook post will cause the Feed to <code class="highlighter-rouge">refresh()</code>, which will fail.)</li>
  <li>For the <strong>client or server error</strong>, change the server to send a status code in the 400 or 500 range to the client instead of the Feed data. Or, change your JSON token to something invalid.</li>
</ul>

<p>Remember to <em>restart</em> the server if you make any modifications to it, and to remove those modifications once you have taken a screenshot!</p>

<p><strong><code class="highlighter-rouge">add</code> the screenshot to your repository as <code class="highlighter-rouge">server/facebook_fail.png</code>, <code class="highlighter-rouge">commit</code> your changes as <code class="highlighter-rouge">failbook</code>, and <code class="highlighter-rouge">push</code> the commit to GitHub.</strong></p>

<p>Our warning message is not too user friendly, though. Can you imagine what your granddad would think after seeing such an error? Good error handling is <em>hard</em>, and constitutes a large portion of a web developer’s work. We will not hold your startups to high standards with regard to error handling, but you may have creative ideas regarding how you may decide to handle them in your own projects!</p>

<h2 id="poststatusupdate-and-validating-data-with-json-schema">postStatusUpdate, and Validating Data with JSON Schema</h2>

<p><code class="highlighter-rouge">postStatusUpdate</code> is the first Express function you will write that accepts complex data from the client.</p>

<p>If there’s anything you take away from this workshop, it should be this: Server requests can contain <em>anything</em>, and can come from <em>anywhere</em>. If a request has a valid JSON Web Token, that only means that the request is coming from an authenticated user (or someone/something who has stolen an authenticated user’s token – called a <a href="https://www.owasp.org/index.php/Session_hijacking_attack"><em>session hijacking attack</em></a>). The authenticated user could still issue malformed requests manually using a tool like Postman. (Or your client could simply have a bug, and be sending garbage data.)</p>

<p><strong>You should be paranoid about the data your server processes.</strong> Is it a JSON object, like you expected? Does it have all of the fields you expect? Are the fields the correct type – e.g. a number for <code class="highlighter-rouge">userId</code>, a string for <code class="highlighter-rouge">content</code>, etc?</p>

<p>It sounds onerous to check all of these things… and it is! Thankfully, you can easily write or <a href="http://jsonschema.net/">generate JSON Schema</a> to check request bodies against, and use <a href="https://www.npmjs.com/package/express-jsonschema"><code class="highlighter-rouge">express-jsonschema</code> middleware</a> to automate this checking.</p>

<p>A JSON schema merely describes the format of a JSON object. Recall that we decided to use the following HTTP request for posting a status update:</p>

<p><code class="highlighter-rouge">POST /feeditem { userId: user, location: location, contents: contents  }</code></p>

<p>The body contains a JSON object with the following fields:</p>

<ul>
  <li><code class="highlighter-rouge">userId</code>: A number with the user ID.</li>
  <li><code class="highlighter-rouge">location</code>: A string containing the user’s location.</li>
  <li><code class="highlighter-rouge">contents</code>: A string containing the status update text.</li>
</ul>

<p>All of these fields are <em>required</em>.</p>

<p>A JSON schema for this data structure would look like the following. (As you may notice, a JSON schema is a JSON object… which means there is a <a href="http://json-schema.org/schema">JSON schema for JSON schemas</a>):</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"$schema"</span><span class="err">:</span> <span class="s2">"http://json-schema.org/draft-04/schema#"</span><span class="p">,</span>
  <span class="s2">"id"</span><span class="err">:</span> <span class="s2">"/"</span><span class="p">,</span>
  <span class="s2">"type"</span><span class="err">:</span> <span class="s2">"object"</span><span class="p">,</span>
  <span class="s2">"properties"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"userId"</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">"id"</span><span class="err">:</span> <span class="s2">"userId"</span><span class="p">,</span>
      <span class="s2">"type"</span><span class="err">:</span> <span class="s2">"integer"</span>
    <span class="p">},</span>
    <span class="s2">"location"</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">"id"</span><span class="err">:</span> <span class="s2">"location"</span><span class="p">,</span>
      <span class="s2">"type"</span><span class="err">:</span> <span class="s2">"string"</span>
    <span class="p">},</span>
    <span class="s2">"contents"</span><span class="err">:</span> <span class="p">{</span>
      <span class="s2">"id"</span><span class="err">:</span> <span class="s2">"contents"</span><span class="p">,</span>
      <span class="s2">"type"</span><span class="err">:</span> <span class="s2">"string"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">"additionalProperties"</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="s2">"required"</span><span class="err">:</span> <span class="p">[</span>
    <span class="s2">"userId"</span><span class="p">,</span>
    <span class="s2">"location"</span><span class="p">,</span>
    <span class="s2">"contents"</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">"required"</code> list lists all of the properties that <em>must</em> be present on the object for it to be valid, and identifies the properties using their <code class="highlighter-rouge">"id"</code> property.</p>

<p>You can <a href="http://jsonschema.net/">automatically generate the above schema at http://jsonschema.net/</a> using a simple example of an object. Untick ‘Use absolute IDs’ and “Allow additional properties”, and enter a sample StatusUpdate JSON object:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
  <span class="s2">"userId"</span><span class="err">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">"location"</span><span class="err">:</span> <span class="s2">"Amherst, MA"</span><span class="p">,</span>
  <span class="s2">"contents"</span><span class="err">:</span> <span class="s2">"are all of the animals in zootopia vegetarian?"</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Clicking ‘Generate Schema’ will create the above schema. JSON schemas have other options, too, which you can explore using that generator.</p>

<p>In the <code class="highlighter-rouge">server</code> directory, create the folder <code class="highlighter-rouge">src/schemas</code>, and create the file <code class="highlighter-rouge">src/schemas/statusupdate.json</code>. Paste the JSON schema from above into it.</p>

<p>In <code class="highlighter-rouge">src/server.js</code>, Node.JS lets you import the JSON like you would a module:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">StatusUpdateSchema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./schemas/statusupdate.json'</span><span class="p">);</span>
</code></pre>
</div>

<p>Now, we can pass this JSON object to the <code class="highlighter-rouge">express-jsonschema</code> validator, and use it in the route for <code class="highlighter-rouge">POST /feeditem</code>! Import the <code class="highlighter-rouge">express-jsonschema</code> <code class="highlighter-rouge">validate</code> function into <code class="highlighter-rouge">src/server.js</code>, and also import <code class="highlighter-rouge">database</code>’s <code class="highlighter-rouge">writeDocument</code> and <code class="highlighter-rouge">addDocument</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">validate</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express-jsonschema'</span><span class="p">).</span><span class="nx">validate</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">writeDocument</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nx">writeDocument</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">addDocument</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nx">addDocument</span><span class="p">;</span>
</code></pre>
</div>

<p>Also, add a <code class="highlighter-rouge">bodyParser</code> for JSON alongsize the existing body parser for text:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Support receiving text in HTTP request bodies</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>
<span class="c1">// Support receiving JSON in HTTP request bodies</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
</code></pre>
</div>

<p>Now, add the <code class="highlighter-rouge">/feeditem</code> POST like so:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Adds a new status update to the database.
 */</span>
<span class="kd">function</span> <span class="nx">postStatusUpdate</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If we were implementing this for real on an actual server, we would check</span>
  <span class="c1">// that the user ID is correct &amp; matches the authenticated user. But since</span>
  <span class="c1">// we're mocking it, we can be less strict.</span>

  <span class="c1">// Get the current UNIX time.</span>
  <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
  <span class="c1">// The new status update. The database will assign the ID for us.</span>
  <span class="kd">var</span> <span class="nx">newStatusUpdate</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"likeCounter"</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"statusUpdate"</span><span class="p">,</span>
    <span class="s2">"contents"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"author"</span><span class="p">:</span> <span class="nx">user</span><span class="p">,</span>
      <span class="s2">"postDate"</span><span class="p">:</span> <span class="nx">time</span><span class="p">,</span>
      <span class="s2">"location"</span><span class="p">:</span> <span class="nx">location</span><span class="p">,</span>
      <span class="s2">"contents"</span><span class="p">:</span> <span class="nx">contents</span><span class="p">,</span>
      <span class="s2">"likeCounter"</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">},</span>
    <span class="c1">// List of comments on the post</span>
    <span class="s2">"comments"</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">};</span>

  <span class="c1">// Add the status update to the database.</span>
  <span class="c1">// Returns the status update w/ an ID assigned.</span>
  <span class="nx">newStatusUpdate</span> <span class="o">=</span> <span class="nx">addDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">newStatusUpdate</span><span class="p">);</span>

  <span class="c1">// Add the status update reference to the front of the current user's feed.</span>
  <span class="kd">var</span> <span class="nx">userData</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">feedData</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">,</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">feed</span><span class="p">);</span>
  <span class="nx">feedData</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">newStatusUpdate</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>

  <span class="c1">// Update the feed object.</span>
  <span class="nx">writeDocument</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">,</span> <span class="nx">feedData</span><span class="p">);</span>

  <span class="c1">// Return the newly-posted object.</span>
  <span class="k">return</span> <span class="nx">newStatusUpdate</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// `POST /feeditem { userId: user, location: location, contents: contents  }`</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/feeditem'</span><span class="p">,</span> 
         <span class="nx">validate</span><span class="p">({</span> <span class="na">body</span><span class="p">:</span> <span class="nx">StatusUpdateSchema</span> <span class="p">}),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If this function runs, `req.body` passed JSON validation!</span>
  <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>

  <span class="c1">// Check if requester is authorized to post this status update.</span>
  <span class="c1">// (The requester must be the author of the update.)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fromUser</span> <span class="o">===</span> <span class="nx">body</span><span class="p">.</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">newUpdate</span> <span class="o">=</span> <span class="nx">postStatusUpdate</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">body</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> 
		                             <span class="nx">body</span><span class="p">.</span><span class="nx">contents</span><span class="p">);</span>
    <span class="c1">// When POST creates a new resource, we should tell the client about it</span>
    <span class="c1">// in the 'Location' header and use status code 201.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">'Location'</span><span class="p">,</span> <span class="s1">'/feeditem/'</span> <span class="o">+</span> <span class="nx">newUpdate</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
     <span class="c1">// Send the update!</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">newUpdate</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 401: Unauthorized.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>In <code class="highlighter-rouge">client/app/server.js</code>, simply change <code class="highlighter-rouge">postStatusUpdate</code> to use <code class="highlighter-rouge">sendXHR</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Adds a new status update to the database.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">postStatusUpdate</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'/feeditem'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">,</span>
    <span class="na">location</span><span class="p">:</span> <span class="nx">location</span><span class="p">,</span>
    <span class="na">contents</span><span class="p">:</span> <span class="nx">contents</span>
  <span class="p">},</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Return the new status update.</span>
    <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<p>If you restart the server and head to <code class="highlighter-rouge">http://localhost:3000</code>, you should be able to post status updates and have them continue to appear when you refresh the page! (Naturally, other features, like “liking” the update, will not work since we’re still using the client-side <code class="highlighter-rouge">database.js</code> for those features.)</p>

<p>Using Postman, send an invalid <code class="highlighter-rouge">POST /feeditem</code> to your server. Remember to set the <code class="highlighter-rouge">Authorization</code> header to “Bearer <token here="">". The response... will be a 500 Internal Server Error. `express-jsonschema` simply throws an error when validation fails, which causes Express to send back an error 500. We really want it to send back an error 400!</token></p>

<p>Express lets us define <a href="http://expressjs.com/en/guide/error-handling.html">custom functions that process errors</a>. Let’s make one that processes “JsonSchemaValidation” errors, which are described in <a href="https://www.npmjs.com/package/express-jsonschema#handling-invalid-data"><code class="highlighter-rouge">express-jsonschema</code>’s README</a>, and turns them into a response with status code 400, “Bad Request”:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Translate JSON Schema Validation failures into error 400s.
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'JsonSchemaValidation'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Set a bad request http response status</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// It's some other sort of error; pass it to next error middleware handler</span>
    <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Add this function to <code class="highlighter-rouge">src/server.js</code> <strong>at the end of the file</strong>, just above <code class="highlighter-rouge">app.listen</code>. It must come <em>after</em> all of our defined routes (e.g. <code class="highlighter-rouge">app.get</code>, <code class="highlighter-rouge">app.post</code>, etc.).</p>

<p>If you restart the server and submit another invalid request with Postman, you’ll get a status code 400: Bad Request. Perfect!</p>

<p><strong><code class="highlighter-rouge">add</code> <code class="highlighter-rouge">src/schemas/statusupdate.json</code>, <code class="highlighter-rouge">commit</code> your changes with message <code class="highlighter-rouge">validation</code>, and <code class="highlighter-rouge">push</code> your changes to GitHub.</strong></p>

<h2 id="implement-the-rest-of-the-routes">Implement the Rest of the Routes</h2>

<p>We are in the home stretch. We have the infrastructure to port over the rest of our methods in <code class="highlighter-rouge">server.js</code>, and you should now have the know-how to implement the comment-related routes on your own!</p>

<p>You’ll commit all of these changes at once, at the end of this section.</p>

<h3 id="reset-database">Reset Database</h3>

<p>Wouldn’t it be nice if our “Reset DB” button reset the database on the server? That would be a useful development feature. Let’s add a <code class="highlighter-rouge">/resetdb</code> route that, when POSTed to, resets the database:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Reset database.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/resetdb'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Resetting database..."</span><span class="p">);</span>
  <span class="c1">// This is a debug route, so don't do any validation.</span>
  <span class="nx">database</span><span class="p">.</span><span class="nx">resetDatabase</span><span class="p">();</span>
  <span class="c1">// res.send() sends an empty response with status code 200</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Change the <code class="highlighter-rouge">ResetDatabase</code> component in <code class="highlighter-rouge">client/app/database.js</code> so that it POSTs to this route:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Reset database button.
 */</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">ResetDatabase</span> <span class="kr">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"btn btn-default"</span> <span class="nx">type</span><span class="o">=</span><span class="s2">"button"</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'/resetdb'</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'load'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="s2">"Database reset! Refreshing the page now..."</span><span class="p">);</span>
          <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
      <span class="p">}}</span><span class="o">&gt;</span><span class="nx">Reset</span> <span class="nx">Mock</span> <span class="nx">DB</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="updatefeeditemtext">updateFeedItemText</h3>

<p>We decided to map this route to <code class="highlighter-rouge">PUT /feeditem/:feeditemid/content text</code>.</p>

<p>Add the following route to <code class="highlighter-rouge">server/src/server.js</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Update a feed item.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/feeditem/:feeditemid/content'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>
  <span class="kd">var</span> <span class="nx">feedItemId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">feeditemid</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">feedItem</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
  <span class="c1">// Check that the requester is the author of this feed item.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fromUser</span> <span class="o">===</span> <span class="nx">feedItem</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Check that the body is a string, and not something like a JSON object.</span>
    <span class="c1">// We can't use JSON validation here, since the body is simply text!</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 400: Bad request.</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Update text content of update.</span>
    <span class="nx">feedItem</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">contents</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="nx">writeDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItem</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">getFeedItemSync</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 401: Unauthorized.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Then, change <code class="highlighter-rouge">client/app/server.js</code> to use this route:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Updates the text in a feed item (assumes a status update)
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">updateFeedItemText</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">,</span> <span class="nx">newContent</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'PUT'</span><span class="p">,</span> <span class="s1">'/feeditem/'</span> <span class="o">+</span> <span class="nx">feedItemId</span> <span class="o">+</span> <span class="s1">'/content'</span><span class="p">,</span> <span class="nx">newContent</span><span class="p">,</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="deletefeeditem">deleteFeedItem</h3>

<p>We decided to map this function to <code class="highlighter-rouge">DELETE /feeditem/feeditemid</code>.</p>

<p>Implement this route in <code class="highlighter-rouge">server/src/server.js</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Delete a feed item.
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/feeditem/:feeditemid'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>
  <span class="c1">// Convert from a string into a number.</span>
  <span class="kd">var</span> <span class="nx">feedItemId</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">feeditemid</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">feedItem</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
  <span class="c1">// Check that the author of the post is requesting the delete.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">feedItem</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">author</span> <span class="o">===</span> <span class="nx">fromUser</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">database</span><span class="p">.</span><span class="nx">deleteDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
    <span class="c1">// Remove references to this feed item from all other feeds.</span>
    <span class="kd">var</span> <span class="nx">feeds</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nx">getCollection</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">feedIds</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">feeds</span><span class="p">);</span>
    <span class="nx">feedIds</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">feedId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">feed</span> <span class="o">=</span> <span class="nx">feeds</span><span class="p">[</span><span class="nx">feedId</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">itemIdx</span> <span class="o">=</span> <span class="nx">feed</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">itemIdx</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Splice out of array.</span>
        <span class="nx">feed</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">itemIdx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="c1">// Update feed.</span>
        <span class="nx">database</span><span class="p">.</span><span class="nx">writeDocument</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">,</span> <span class="nx">feed</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="c1">// Send a blank response to indicate success.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 401: Unauthorized.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Then, change <code class="highlighter-rouge">client/app/server.js</code> to use it:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Deletes a feed item.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">deleteFeedItem</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'DELETE'</span><span class="p">,</span> <span class="s1">'/feeditem/'</span> <span class="o">+</span> <span class="nx">feedItemId</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="likefeeditem">likeFeedItem</h3>

<p>We decided to map this function to <code class="highlighter-rouge">PUT /feeditem/feeditemid/likelist/userid</code>.</p>

<p>Implement this route in <code class="highlighter-rouge">server/src/server.js</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Like a feed item.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">'/feeditem/:feeditemid/likelist/:userid'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>
  <span class="c1">// Convert params from string to number.</span>
  <span class="kd">var</span> <span class="nx">feedItemId</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">feeditemid</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userid</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fromUser</span> <span class="o">===</span> <span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">feedItem</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
    <span class="c1">// Add to likeCounter if not already present.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
      <span class="nx">writeDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItem</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Return a resolved version of the likeCounter</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">userId</span><span class="p">)</span> <span class="o">=&gt;</span> 
	                                  <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">userId</span><span class="p">)));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 401: Unauthorized.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Then, change <code class="highlighter-rouge">client/app/server.js</code> to use this route:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Updates a feed item's likeCounter by adding the user to the likeCounter.
 * Provides an updated likeCounter in the response.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">likeFeedItem</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'PUT'</span><span class="p">,</span> <span class="s1">'/feeditem/'</span> <span class="o">+</span> <span class="nx">feedItemId</span> <span class="o">+</span> <span class="s1">'/likelist/'</span> <span class="o">+</span> <span class="nx">userId</span><span class="p">,</span> 
          <span class="kc">undefined</span><span class="p">,</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="unlikefeeditem">unlikeFeedItem</h3>

<p>We decided to map this function to <code class="highlighter-rouge">DELETE /feeditem/feeditemid/likelist/userid</code>.</p>

<p>Add this route to <code class="highlighter-rouge">server/src/server.js</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Unlike a feed item.</span>
<span class="nx">app</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/feeditem/:feeditemid/likelist/:userid'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>
  <span class="c1">// Convert params from string to number.</span>
  <span class="kd">var</span> <span class="nx">feedItemId</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">feeditemid</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">userid</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">fromUser</span> <span class="o">===</span> <span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">feedItem</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemId</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">likeIndex</span> <span class="o">=</span> <span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>
    <span class="c1">// Remove from likeCounter if present</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">likeIndex</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">likeIndex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">writeDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItem</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// Return a resolved version of the likeCounter</span>
    <span class="c1">// Note that this request succeeds even if the </span>
	<span class="c1">// user already unliked the request!</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">feedItem</span><span class="p">.</span><span class="nx">likeCounter</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">userId</span><span class="p">)</span> <span class="o">=&gt;</span> 
		                                <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">userId</span><span class="p">)));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 401: Unauthorized.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Then, change <code class="highlighter-rouge">client/app/server.js</code> to use this route:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Updates a feed item's likeCounter by removing the user 
 * from the likeCounter. Provides an updated likeCounter 
 * in the response.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">unlikeFeedItem</span><span class="p">(</span><span class="nx">feedItemId</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'DELETE'</span><span class="p">,</span> <span class="s1">'/feeditem/'</span> <span class="o">+</span> <span class="nx">feedItemId</span> <span class="o">+</span> <span class="s1">'/likelist/'</span> <span class="o">+</span> <span class="nx">userId</span><span class="p">,</span> 
	      <span class="kc">undefined</span><span class="p">,</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="searchforfeeditems">searchForFeeditems</h3>

<p>We decided to map this route to <code class="highlighter-rouge">POST /search searchtext</code>.</p>

<p>Add this route to <code class="highlighter-rouge">server/src/server.js</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// Search for feed item</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/search'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">fromUser</span> <span class="o">=</span> <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'Authorization'</span><span class="p">));</span>
  <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'users'</span><span class="p">,</span> <span class="nx">fromUser</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// trim() removes whitespace before and after the query.</span>
    <span class="c1">// toLowerCase() makes the query lowercase.</span>
    <span class="kd">var</span> <span class="nx">queryText</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="c1">// Search the user's feed.</span>
    <span class="kd">var</span> <span class="nx">feedItemIDs</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feeds'</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">feed</span><span class="p">).</span><span class="nx">contents</span><span class="p">;</span>
    <span class="c1">// "filter" is like "map" in that it is a magic method for</span>
    <span class="c1">// arrays. It takes an anonymous function, which it calls</span>
    <span class="c1">// with each item in the array. If that function returns 'true',</span>
    <span class="c1">// it will include the item in a return array. Otherwise, it will</span>
    <span class="c1">// not.</span>
    <span class="c1">// Here, we use filter to return only feedItems that contain the</span>
    <span class="c1">// query text.</span>
    <span class="c1">// Since the array contains feed item IDs, we later map the filtered</span>
    <span class="c1">// IDs to actual feed item objects.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">feedItemIDs</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">feedItemID</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">feedItem</span> <span class="o">=</span> <span class="nx">readDocument</span><span class="p">(</span><span class="s1">'feedItems'</span><span class="p">,</span> <span class="nx">feedItemID</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">feedItem</span><span class="p">.</span><span class="nx">contents</span><span class="p">.</span><span class="nx">contents</span>
	                 <span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
					 <span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">queryText</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="nx">getFeedItemSync</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 400: Bad Request.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Then, update <code class="highlighter-rouge">client/app/server.js</code> to use this route:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="cm">/**
 * Searches for feed items with the given text.
 */</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">searchForFeedItems</span><span class="p">(</span><span class="nx">userID</span><span class="p">,</span> <span class="nx">queryText</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// userID is not needed; it's included in the JSON web token.</span>
  <span class="nx">sendXHR</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'/search'</span><span class="p">,</span> <span class="nx">queryText</span><span class="p">,</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">cb</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="commit-your-changes">Commit Your Changes</h2>

<p>If you rerun your server, you should now be able to do the following activities on
Facebook:</p>

<ul>
  <li>Post status updates</li>
  <li>Edit status updates you have authored</li>
  <li>Delete status updates</li>
  <li>Reset the server’s database</li>
  <li>Search for status updates</li>
  <li>Like status updates</li>
  <li>Unlike status updates</li>
</ul>

<p>If something doesn’t work, it should surface on your Facebook page as an error. Maybe you pasted something incorrectly?</p>

<p>Once everything checks out and works, <strong><code class="highlighter-rouge">commit</code> your changes with message <code class="highlighter-rouge">almostDone</code>, and <code class="highlighter-rouge">push</code> your changes to GitHub.</strong></p>

<h1 id="add-comment-routes-yourself">Add Comment Routes Yourself!</h1>

<p>Previously, we asked you to think about what HTTP resources you should use for comments and their LikeList, and what HTTP requests to use for <code class="highlighter-rouge">postComment</code>, <code class="highlighter-rouge">likeComment</code>, and <code class="highlighter-rouge">unlikeComment</code>. Now, you must implement those HTTP requests using the knowledge you have learned in this workshop.</p>

<p>Specifically, you will need to do the following:</p>

<ul>
  <li>Add a route to the server for <code class="highlighter-rouge">postComment</code>, <code class="highlighter-rouge">likeComment</code>, and <code class="highlighter-rouge">unlikeComment</code>.</li>
  <li>Update the functions in <code class="highlighter-rouge">client/app/server.js</code> to issue HTTP requests.</li>
  <li>Create a JSON schema for comment data, and place it into <code class="highlighter-rouge">server/src/schemas/comment.json</code></li>
  <li>Validate comment data input to <code class="highlighter-rouge">postComment</code> using the JSON schema.</li>
</ul>

<p>All of this is plainly described in the grading rubric, and we will test for all of these things!</p>

<p>Once you’re done, <strong><code class="highlighter-rouge">commit</code> your changes with message <code class="highlighter-rouge">missionAccomplished</code>, and <code class="highlighter-rouge">push</code> your changes to GitHub</strong>.</p>

<h1 id="conclusion">Conclusion</h1>

<p>You did it! You’ve written a server for Facebook.</p>

<p>Through this workshop, you’ve learned:</p>

<ul>
  <li>What HTTP is, including what information is included in HTTP requests/responses</li>
  <li>How to map HTTP resources to database entities</li>
  <li>How to map mock server requests to HTTP requests</li>
  <li>What Node.JS is, and how to write Node.JS programs</li>
  <li>How to debug Node.JS programs</li>
  <li>What Express is, and how to write Express servers</li>
  <li>How to send arbitrary HTTP requests to Express servers using Postman</li>
  <li>How to validate data sent to servers using JSON schema</li>
</ul>

<p>By now, you should have all of the knowledge required to add a server to your
startup product!</p>

<h1 id="submission">Submission</h1>

<p>You must submit the URL of your <strong>Workshop6</strong> GitHub repository to Moodle. Visit Moodle, find the associated <strong>Workshop 9</strong> activity, and provide your URL. Make sure your <strong>Workshop6</strong> repository is public so we can clone your repository and evaluate your work. <strong>Submitting the URL for this assignment is part of completing the work.</strong></p>

  </div>

</article>
      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">COMPSCI 326 Web Programming</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Tim Richards
            
            </li>
            
            <li>richards at cs dot umass dot edu</li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Spring 2017 Web Programming
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
